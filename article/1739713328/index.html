<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <!--    <meta name="referrer" content="origin">-->
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>
        
            03、RocketMQ源码分析：Broker启动流程源码解析【一万字】
        
    </title>
    <link rel="shortcut icon" href="#"/>

    <link type="text/css" rel="stylesheet" href="/font/LongCang.css">
    <link type="text/css" rel="stylesheet" href="/font/Monda.css">
    <link type="text/css" rel="stylesheet" href="/font/NotoSansSC.css">
    <link type="text/css" rel="stylesheet" href="/font/NotoSerifSC.css">
    <link type="text/css" rel="stylesheet" href="/font/Playball.css">
    <link type="text/css" rel="stylesheet" href="/font/PTMono.css">
    <link type="text/css" rel="stylesheet" href="/font/Roboto.css">
    <link type="text/css" rel="stylesheet" href="/font/RobotoSlab.css">
    <link type="text/css" rel="stylesheet" href="/font/Rosario.css">
    <link type="text/css" rel="stylesheet" href="/font/UbuntuMono.css">

    <link type="text/css" rel="stylesheet" href="/css/base.css">
    <link type="text/css" rel="stylesheet" href="/css/code.css">

    <script type="text/javascript" src="/js/jquery-3.4.1.min.js"></script>
<meta name="generator" content="Hexo 6.2.0"></head>
<body>
    <a id="cover"></a>
    <link type="text/css" rel="stylesheet" href="/css/post.css">
<header>
    <meta name="referrer" content="no-referrer">
</header>
<div id="header" class="header">
    <div class="vertical">
        <div class="inner">
            
                <h1 class="header-subtitle">03、RocketMQ源码分析：Broker启动流程源码解析【一万字】</h1>
                <div class="header-subinfo">
                    <p class="article-info-text">
                        <span>
                            <i class="iconfont icon-time"></i> 发表时间：2025-02-16
                        </span>
                        
                            <span id="/article/1739713328/" class="leancloud_visitors" data-flag-title="03、RocketMQ源码分析：Broker启动流程源码解析【一万字】">
                                <i class="iconfont icon-browse"></i> 阅读：<sapn class="leancloud-visitors-count"></span>
                            </span>
                        
                        <span>
                            <i class="iconfont icon-interactive"></i> 评论：<span class="valine-comment-count" data-xid="/article/1739713328/"></span>
                        </span>
                    </p>
                    
                        
                            <span class="category-color">Web</span>
                        
                    
                    
                        
                            <span class="tag-color">RocketMq</span>
                        
                    
                </div>
            
        </div>
    </div>
    
</div>
<div id="container">
    
        <!-- 文章页面 -->
        <div id="article">
            <div class="toc"></div>
            <div class="article-body">
                <h1 id="03、RocketMQ源码分析：Broker启动流程源码解析【一万字】"><a href="#03、RocketMQ源码分析：Broker启动流程源码解析【一万字】" class="headerlink" title="03、RocketMQ源码分析：Broker启动流程源码解析【一万字】"></a>03、RocketMQ源码分析：Broker启动流程源码解析【一万字】</h1><ul>
<li><em>此前我们学习了NameServer的启动流程源码：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43767015/article/details/124524608">RocketMQ源码(2)—NameServer启动流程源码解析</a><br>，现在我们来学习Broker的启动流程源码，因为RocketMQ在启动的时候，最先启动NameServer，然后再启动Broker的。</em>*</li>
</ul>
<p>同NameServer源码学习的开头说的那样，我们一样要先学会了如何使用RocketMQ，并且看了官方文档之后再来看源码，那样就能节约很多的时间，并且能够和文档上所讲的对得上号。比如RocketMQ的<a href="https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md">架构设计</a><br>，以及<a href="https://github.com/apache/rocketmq/tree/master/docs/cn">Apache RocketMQ开发者指南</a>。</p>
<p>官方介绍：Broker主要负责消息的存储、投递和查询以及服务高可用保证，为了实现这些功能，Broker包含了以下几个重要子模块。</p>
<p><strong>1、</strong> RemotingModule：整个Broker的实体，负责处理来自Client端的请求；<br><strong>2、</strong> ClientManager：负责管理客户端(Producer&#x2F;Consumer)和维护Consumer的Topic订阅信息；<br><strong>3、</strong> StoreService：提供方便简单的API接口处理消息存储到物理硬盘和查询功能；<br><strong>4、</strong> HAService：高可用服务，提供MasterBroker和SlaveBroker之间的数据同步功能；<br><strong>5、</strong> IndexService：根据特定的Messagekey对投递到Broker的消息进行索引服务，以提供消息的快速查询；</p>
<h4 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h4><ul>
<li>1 BrokerStartup启动入口</li>
<li>2 createBrokerController创建BrokerController</li>
<li><ul>
<li>2.1 创建各种配置类</li>
</ul>
</li>
<li>2.2 创建broker控制器</li>
<li>2.3 初始化broker控制器</li>
<li><ul>
<li>2.3.1 加载配置文件</li>
<li>2.3.2 创建消息存储对象MessageStore</li>
<li>2.3.3 Load加载恢复消息文件</li>
<li>2.3.4 初始化Broker通信层</li>
<li>2.3.5 创建各种执行器线程池</li>
<li>2.3.6 注册netty消息处理器</li>
<li><ul>
<li>2.3.6.1 registerProcessor注册处理器</li>
</ul>
</li>
<li>2.3.7 启动定时周期任务</li>
<li>2.3.8 初始化事务消息相关服务</li>
<li>2.3.9 初始化ACL权限服务</li>
<li>2.3.10 初始化RpCHook</li>
</ul>
</li>
<li>2.4 多端口监听</li>
<li>3 Start启动BrokerController</li>
<li>4 Broker启动流程总结</li>
</ul>
<h2 id="1-BrokerStartup启动入口"><a href="#1-BrokerStartup启动入口" class="headerlink" title="1 BrokerStartup启动入口"></a>1 BrokerStartup启动入口</h2><p>Broker的启动入口就是broker模块的BrokerStartup类的main方法。该方法将会创建并且初始化一个BrokerController实例。看起来和NameServer的流程差不多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//启动broker的入口</span></span><br><span class="line">    <span class="comment">//创建并启动一个BrokerController实例</span></span><br><span class="line">    start(createBrokerController(args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-createBrokerController创建BrokerController"><a href="#2-createBrokerController创建BrokerController" class="headerlink" title="2 createBrokerController创建BrokerController"></a>2 createBrokerController创建BrokerController</h2><ul>
<li>*该方法主要是解析命令行，加载Broker配置，以及NettyServer、NettyClient的各种配置（解析命令行中-c指定的配置文件）并保存起来，然后进行一些配置的校验，日志的配置，随后创建一个BrokerController实例。<br>**</li>
</ul>
<p>**BrokerController相当于Broker的一个中央控制器类。创建了BrokerController实例之后，再调用initialize方法进行初始化操作。这是核心方法。<br>**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title function_">createBrokerController</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//设置RocketMQ的版本信息，设置属性rocketmq.remoting.version，即当前rocketmq版本</span></span><br><span class="line">    System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//PackageConflictDetect.detectFastjson();</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 1 jar包启动时，构建命令行操作的指令，使用main方法启动可以忽略</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> ServerUtil.buildCommandlineOptions(<span class="keyword">new</span> <span class="title class_">Options</span>());</span><br><span class="line">        <span class="comment">//mqbroker命令文件</span></span><br><span class="line">        commandLine = ServerUtil.parseCmdLine(<span class="string">&quot;mqbroker&quot;</span>, args, buildCommandlineOptions(options),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">PosixParser</span>());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == commandLine) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 2 创建broker的配置类</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//创建Broker的配置类，包含Broker的各种配置，比如ROCKETMQ_HOME</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BrokerConfig</span> <span class="variable">brokerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrokerConfig</span>();</span><br><span class="line">        <span class="comment">//NettyServer的配置类，Broker作为服务端，比如接收来自客户端的消息的时候</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">NettyServerConfig</span> <span class="variable">nettyServerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyServerConfig</span>();</span><br><span class="line">        <span class="comment">//NettyClient的配置类，Broker还会作为客户端，比如连接NameServer的时候</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">NettyClientConfig</span> <span class="variable">nettyClientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyClientConfig</span>();</span><br><span class="line">        <span class="comment">// tls安全相关配置</span></span><br><span class="line">        nettyClientConfig.setUseTLS(Boolean.parseBoolean(System.getProperty(TLS_ENABLE,</span><br><span class="line">                String.valueOf(TlsSystemConfig.tlsMode == TlsMode.ENFORCING))));</span><br><span class="line">        <span class="comment">//设置作为NettyServer时的监听端口为10911</span></span><br><span class="line">        nettyServerConfig.setListenPort(<span class="number">10911</span>);</span><br><span class="line">        <span class="comment">//Broker的消息存储配置，例如各种文件大小等</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">MessageStoreConfig</span> <span class="variable">messageStoreConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageStoreConfig</span>();</span><br><span class="line">        <span class="comment">//如果broker的角色是slave，设置命中消息在内存的最大比例</span></span><br><span class="line">        <span class="comment">//默认broker角色是异步master</span></span><br><span class="line">        <span class="keyword">if</span> (BrokerRole.SLAVE == messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//30</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ratio</span> <span class="operator">=</span> messageStoreConfig.getAccessMessageInMemoryMaxRatio() - <span class="number">10</span>;</span><br><span class="line">            messageStoreConfig.setAccessMessageInMemoryMaxRatio(ratio);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 3 解析外部配置文件</span></span><br><span class="line"><span class="comment">         * 判断命令行中是否包含字符&#x27;c&#x27;，即是否包含通过命令行指定配置文件的命令</span></span><br><span class="line"><span class="comment">         * 例如，启动Broker的时候添加的 -c /Volumes/Samsung/Idea/rocketmq/config/conf/broker.conf命令</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (commandLine.hasOption(<span class="string">&#x27;c&#x27;</span>)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//获取该命令指定的配置文件</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> commandLine.getOptionValue(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (file != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//加载外部配置文件</span></span><br><span class="line">                configFile = file;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file));</span><br><span class="line">                properties = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">                properties.load(in);</span><br><span class="line">                <span class="comment">//将rmqAddressServerDomain、rmqAddressServerSubGroup属性设置为系统属性</span></span><br><span class="line">                properties2SystemEnv(properties);</span><br><span class="line">                <span class="comment">//设置broker的配置信息</span></span><br><span class="line">                MixAll.properties2Object(properties, brokerConfig);</span><br><span class="line">                <span class="comment">//设置nettyServer的配置信息</span></span><br><span class="line">                MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line">                <span class="comment">//设置nettyClient的配置信息</span></span><br><span class="line">                MixAll.properties2Object(properties, nettyClientConfig);</span><br><span class="line">                <span class="comment">//设置messageStore的配置信息</span></span><br><span class="line">                MixAll.properties2Object(properties, messageStoreConfig);</span><br><span class="line">                <span class="comment">//设置配置文件路径</span></span><br><span class="line">                BrokerPathConfigHelper.setBrokerConfigPath(file);</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置broker的配置信息</span></span><br><span class="line">        MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), brokerConfig);</span><br><span class="line">        <span class="comment">//如果不存在ROCKETMQ_HOME的配置，那么打印异常并退出程序</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == brokerConfig.getRocketmqHome()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            System.out.printf(<span class="string">&quot;Please set the %s variable in your environment to match the location of the RocketMQ installation&quot;</span>, MixAll.ROCKETMQ_HOME_ENV);</span><br><span class="line">            System.exit(-<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 4 获取namesrvAddr，即NameServer的地址，并进行校验</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">namesrvAddr</span> <span class="operator">=</span> brokerConfig.getNamesrvAddr();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != namesrvAddr) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//拆分NameServer的地址</span></span><br><span class="line">                <span class="comment">//可以指定多个NameServer的地址，以&quot;;&quot;分隔</span></span><br><span class="line">                String[] addrArray = namesrvAddr.split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">                <span class="comment">//将字符串的地址，转换为网络连接的SocketAddress，检测格式是否正确</span></span><br><span class="line">                <span class="keyword">for</span> (String addr : addrArray) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    RemotingUtil.string2SocketAddress(addr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                System.out.printf(</span><br><span class="line">                        <span class="string">&quot;The Name Server Address[%s] illegal, please set it as follows, \&quot;127.0.0.1:9876;192.168.0.1:9876\&quot;%n&quot;</span>,</span><br><span class="line">                        namesrvAddr);</span><br><span class="line">                System.exit(-<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 4 设置、校验brokerId</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 根据broker的角色配置brokerId，默认角色是ASYNC_MASTER</span></span><br><span class="line"><span class="comment">         * 通过此配置可知BrokerId为0表示Master，非0表示Slave</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">switch</span> (messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="keyword">case</span> ASYNC_MASTER:</span><br><span class="line">            <span class="keyword">case</span> SYNC_MASTER:</span><br><span class="line">                <span class="comment">//如果是master角色，那么设置brokerId为0</span></span><br><span class="line">                brokerConfig.setBrokerId(MixAll.MASTER_ID);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SLAVE:</span><br><span class="line">                <span class="comment">//如果是slave角色，需要brokerId大于0</span></span><br><span class="line">                <span class="keyword">if</span> (brokerConfig.getBrokerId() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    System.out.printf(<span class="string">&quot;Slave&#x27;s brokerId must be &gt; 0&quot;</span>);</span><br><span class="line">                    System.exit(-<span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 开启 DLeger 的操作</span></span><br><span class="line">        <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            brokerConfig.setBrokerId(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 5 设置高可用通信监听端口，为监听端口+1，默认就是10912</span></span><br><span class="line"><span class="comment">         * 该端口主要用于比如主从同步之类的高可用操作</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 在配置broker集群的时候需要注意，配置集群时可能会抛出：Address already in use</span></span><br><span class="line"><span class="comment">         * 因为一个broker机器会占用三个端口，监听ip端口，以及监听ip端口+1的端口，监听ip端口-2端口</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        messageStoreConfig.setHaListenPort(nettyServerConfig.getListenPort() + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 6 日志相关配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">LoggerContext</span> <span class="variable">lc</span> <span class="operator">=</span> (LoggerContext) LoggerFactory.getILoggerFactory();</span><br><span class="line">        <span class="comment">//Joran 是 logback 使用的一个配置加载库，可以直接调用JoranConfigurator类重新实现logback的配置机制，</span></span><br><span class="line">        <span class="type">JoranConfigurator</span> <span class="variable">configurator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JoranConfigurator</span>();</span><br><span class="line">        configurator.setContext(lc);</span><br><span class="line">        lc.reset();</span><br><span class="line">        <span class="comment">//配置broker日志文件的路徑</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;brokerLogDir&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">//isolateLogEnable属性表示在同一台机器上部署多个broker时是否区分日志路径，默認false</span></span><br><span class="line">        <span class="keyword">if</span> (brokerConfig.isIsolateLogEnable()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            System.setProperty(<span class="string">&quot;brokerLogDir&quot;</span>, brokerConfig.getBrokerName() + <span class="string">&quot;_&quot;</span> + brokerConfig.getBrokerId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (brokerConfig.isIsolateLogEnable() &amp;&amp; messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            System.setProperty(<span class="string">&quot;brokerLogDir&quot;</span>, brokerConfig.getBrokerName() + <span class="string">&quot;_&quot;</span> + messageStoreConfig.getdLegerSelfId());</span><br><span class="line">        &#125;</span><br><span class="line">        configurator.doConfigure(brokerConfig.getRocketmqHome() + <span class="string">&quot;/conf/logback_broker.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*判断命令行中是否包含字符&#x27;p&#x27;（printConfigItem）和&#x27;m&#x27;，如果存在则打印配置信息并结束jvm运行，没有的话就不用管*/</span></span><br><span class="line">        <span class="keyword">if</span> (commandLine.hasOption(<span class="string">&#x27;p&#x27;</span>)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="type">InternalLogger</span> <span class="variable">console</span> <span class="operator">=</span> InternalLoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">            MixAll.printObjectProperties(console, brokerConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyServerConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyClientConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, messageStoreConfig);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">&#x27;m&#x27;</span>)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="type">InternalLogger</span> <span class="variable">console</span> <span class="operator">=</span> InternalLoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">            MixAll.printObjectProperties(console, brokerConfig, <span class="literal">true</span>);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyServerConfig, <span class="literal">true</span>);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyClientConfig, <span class="literal">true</span>);</span><br><span class="line">            MixAll.printObjectProperties(console, messageStoreConfig, <span class="literal">true</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打印当前broker的配置日志</span></span><br><span class="line">        log = InternalLoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</span><br><span class="line">        MixAll.printObjectProperties(log, brokerConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyClientConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, messageStoreConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 7 实例化BrokerController，设置各种属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BrokerController</span> <span class="variable">controller</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrokerController</span>(</span><br><span class="line">                brokerConfig,</span><br><span class="line">                nettyServerConfig,</span><br><span class="line">                nettyClientConfig,</span><br><span class="line">                messageStoreConfig);</span><br><span class="line">        <span class="comment">// 将所有的-c的外部配置信息保存到NamesrvController中的Configuration对象属性的allConfigs属性中</span></span><br><span class="line">        controller.getConfiguration().registerConfig(properties);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 8 初始化BrokerController</span></span><br><span class="line"><span class="comment">         * 创建netty远程服务，初始化Netty线程池，注册请求处理器，配置定时任务，用于扫描并移除不活跃的Broker等操作。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">initResult</span> <span class="operator">=</span> controller.initialize();</span><br><span class="line">        <span class="comment">//初始化失败则退出</span></span><br><span class="line">        <span class="keyword">if</span> (!initResult) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            controller.shutdown();</span><br><span class="line">            System.exit(-<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 9 添加关闭钩子方法，在Broker关闭之前执行，进行一些内存清理、对象销毁等操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">hasShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">shutdownTimes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.info(<span class="string">&quot;Shutdown hook was invoked, &#123;&#125;&quot;</span>, <span class="built_in">this</span>.shutdownTimes.incrementAndGet());</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">this</span>.hasShutdown) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                        <span class="built_in">this</span>.hasShutdown = <span class="literal">true</span>;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                        <span class="comment">//执行controller的shutdown方法，并且还会在messageStore#shutdown方法中将abort临时文件删除。</span></span><br><span class="line">                        controller.shutdown();</span><br><span class="line">                        <span class="type">long</span> <span class="variable">consumingTimeTotal</span> <span class="operator">=</span> System.currentTimeMillis() - beginTime;</span><br><span class="line">                        log.info(<span class="string">&quot;Shutdown hook over, consuming total time(ms): &#123;&#125;&quot;</span>, consumingTimeTotal);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;ShutdownHook&quot;</span>));</span><br><span class="line">        <span class="comment">//返回BrokerController</span></span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-创建各种配置类"><a href="#2-1-创建各种配置类" class="headerlink" title="2.1 创建各种配置类"></a>2.1 创建各种配置类</h3><p><strong>createBrokerController方法中，首先就会创建各种配置类。重要的broker的各种配置类如下：</strong></p>
<p><strong>1、</strong> <strong>BrokerConfig</strong>：Broker的配置类，包含Broker的各种配置，比如ROCKETMQ_HOME、namesrvAddr、brokerName、brokerId等属性；<br><strong>2、</strong> <strong>NettyServerConfig</strong><br>：NettyServer的配置类，包含Broker作为服务端时的各种属性，比如客户端进行交互的时候设置作为NettyServer时的监听端口为10911即客户端与Broker通信时使用10911端口；<br><strong>3、</strong> NettyClientConfig：NettyClient的配置类，包含Broker作为客户端时的各种属性，Broker还会作为客户端，比如与NameServer交互的时候；<br><strong>4、</strong> <strong>MessageStoreConfig</strong>：Broker消息存储的配置类，包含了消息存储的相关配置比如各种文件的目录、大小等信息；</p>
<p><strong>然后还会将-c指令（c即configFile）指定的外部配置文件中的属性设置给这些配置类，我们可以通过在启动时追加类似于“-c<br>xx&#x2F;xx&#x2F;xx&#x2F;配置文件目录”的指令指定外部配置文件。</strong></p>
<p>常见的外部配置文件配置的内容及其含义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">brokerClusterName = <span class="type">DefaultCluster</span></span><br><span class="line"><span class="variable">brokerName</span> <span class="operator">=</span> broker-<span class="type">a</span></span><br><span class="line"><span class="variable">brokerId</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">#删除文件的时间点，一天的固定时间执行一次删除过期文件操作，默认为凌晨<span class="number">4</span>点。</span><br><span class="line">deleteWhen = <span class="number">04</span></span><br><span class="line">#文件保留时间，也就是从最后一次更新时间到现在，如果超过了该时间，则认为是过期文件，可以被删除，单位小时</span><br><span class="line">fileReservedTime = <span class="number">48</span></span><br><span class="line">#broker的角色，默认是异步master，即生产者发送的每一条消息只要写入master就返回告诉生产者成功。然后再“异步复制”到slave。</span><br><span class="line">#同步master：Sync Broker：生产者发送的每一条消息都至少同步复制到一个slave后才返回告诉生产者成功，即“同步双写”。</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line">#消息刷盘策略，默认是异步刷盘。</span><br><span class="line">#异步刷盘ASYNC_FLUSH：生产者发送的每一条消息并不是立即保存到磁盘，而是暂时缓存起来，然后就返回生产者成功。随后再异步的将缓存数据保存到磁盘，有两种情况：</span><br><span class="line">#<span class="number">1</span>是定期将缓存中更新的数据进行刷盘，<span class="number">2</span>是当缓存中更新的数据条数达到某一设定值后进行自动刷盘。异步刷盘有较低概率导致消息丢失，比如在还未来得及同步到磁盘的时候宕机，但是性能更好。</span><br><span class="line">#同步刷盘SYNC_FLUSH：生产者发送的每一条消息都在保存到磁盘成功后才返回告诉生产者成功。这种方式不会存在消息丢失的问题，但是有很大的磁盘IO开销，性能有一定影响。</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line"></span><br><span class="line">#nameserver的地址，也可以指定真实ip</span><br><span class="line">namesrvAddr=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9876</span></span><br><span class="line">#brokerIp，也可以指定真实ip</span><br><span class="line">brokerIP1=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">#消息存储根路径</span><br><span class="line">storePathRootDir=F:/Idea/rocketmq/config/store</span><br><span class="line">#commitLog文件的存储路径</span><br><span class="line">storePathCommitLog=F:/Idea/rocketmq/config/store/commitlog</span><br><span class="line">#consume queue文件的存储路径</span><br><span class="line">storePathConsumeQueue=F:/Idea/rocketmq/config/store/consumequeue</span><br><span class="line">#消息索引文件的存储路径</span><br><span class="line">storePathIndex=F:/Idea/rocketmq/config/store/index</span><br><span class="line">#checkpoint文件的存储路径</span><br><span class="line">storeCheckpoint=F:/Idea/rocketmq/config/store/checkpoint</span><br><span class="line">#abort文件的存储路径</span><br><span class="line">abortFile=F:/Idea/rocketmq/config/store/abort</span><br></pre></td></tr></table></figure>

<p>设置了配置信息之后，会及进行一系列的校验，例如：</p>
<p><strong>1、</strong> <strong>ROCKETMQ_HOME</strong>校验：如果在启动参数中没有指定ROCKETMQ_HOME属性，那么打印异常并退出程序ROCKETMQ_HOME就是指定RocketMQ的配置文件路径；<br><strong>2、</strong> <strong>namesrvAddr</strong>校验：我们可以配置多个Nameserver地址，以“；”分割，这里Broker会通过将各个Nameserver的字符串地址转换为InetSocketAddress来校验各个地址的合法性；<br><strong>3、</strong> 设置、校验<strong>brokerId</strong>：如果broker是同步master或者异步master角色，则设置brokerId为0，如果是slave角色，则校验设置的brokerId如果不大于0，则打印异常，并推出程序；</p>
<h3 id="2-2-创建broker控制器"><a href="#2-2-创建broker控制器" class="headerlink" title="2.2 创建broker控制器"></a>2.2 创建broker控制器</h3><ul>
<li><p>*在设置了创建了各种配置类并且解析设置了配置文件中的属性之后。将会根据BrokerConfig、NettyServerConfig、NettyClientConfig、MessageStoreConfig配置类这些配置类调用BrokerController的构造器创建一个BrokerController实例。<br>**</p>
</li>
<li><p>*BrokerController的构造器实际上同样是在进行一系列的赋值和初始化操作，创建各种manager、queue等等各种组件。我们说过BrokerController相当于broker的一个中央控制器，各种组件角色之间的交互都是通过BrokerController来完成的，而不是组件的直接互相调用。<br>**</p>
</li>
</ul>
<p>从下面的源码可以看出，实例化BrokerController的时候，会一并实例化很多的配置类和线程池队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BrokerController</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> BrokerConfig brokerConfig,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> NettyServerConfig nettyServerConfig,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> NettyClientConfig nettyClientConfig,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> MessageStoreConfig messageStoreConfig</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//broker的配置</span></span><br><span class="line">    <span class="built_in">this</span>.brokerConfig = brokerConfig;</span><br><span class="line">    <span class="comment">//作为netty服务端与客户端交互的配置</span></span><br><span class="line">    <span class="built_in">this</span>.nettyServerConfig = nettyServerConfig;</span><br><span class="line">    <span class="comment">//作为netty客户端与服务端交互的配置</span></span><br><span class="line">    <span class="built_in">this</span>.nettyClientConfig = nettyClientConfig;</span><br><span class="line">    <span class="comment">//消息存储的配置</span></span><br><span class="line">    <span class="built_in">this</span>.messageStoreConfig = messageStoreConfig;</span><br><span class="line">    <span class="comment">//消费者偏移量管理器，维护offset进度信息</span></span><br><span class="line">    <span class="built_in">this</span>.consumerOffsetManager = messageStoreConfig.isEnableLmq() ? <span class="keyword">new</span> <span class="title class_">LmqConsumerOffsetManager</span>(<span class="built_in">this</span>) : <span class="keyword">new</span> <span class="title class_">ConsumerOffsetManager</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//topic配置管理器，管理broker中存储的所有topic的配置</span></span><br><span class="line">    <span class="built_in">this</span>.topicConfigManager = messageStoreConfig.isEnableLmq() ? <span class="keyword">new</span> <span class="title class_">LmqTopicConfigManager</span>(<span class="built_in">this</span>) : <span class="keyword">new</span> <span class="title class_">TopicConfigManager</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//拉取消息处理器，用于处理拉取消息的请求</span></span><br><span class="line">    <span class="built_in">this</span>.pullMessageProcessor = <span class="keyword">new</span> <span class="title class_">PullMessageProcessor</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//拉取请求挂起服务，处理无消息时push长轮询消费者的挂起等待机制</span></span><br><span class="line">    <span class="built_in">this</span>.pullRequestHoldService = messageStoreConfig.isEnableLmq() ? <span class="keyword">new</span> <span class="title class_">LmqPullRequestHoldService</span>(<span class="built_in">this</span>) : <span class="keyword">new</span> <span class="title class_">PullRequestHoldService</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//消息送达的监听器，生产者消息到达时通过该监听器触发pullRequestHoldService通知pullRequestHoldService</span></span><br><span class="line">    <span class="built_in">this</span>.messageArrivingListener = <span class="keyword">new</span> <span class="title class_">NotifyMessageArrivingListener</span>(<span class="built_in">this</span>.pullRequestHoldService);</span><br><span class="line">    <span class="comment">//消费者id变化监听器</span></span><br><span class="line">    <span class="built_in">this</span>.consumerIdsChangeListener = <span class="keyword">new</span> <span class="title class_">DefaultConsumerIdsChangeListener</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//消费者管理类，维护消费者组的注册实例信息以及topic的订阅信息，并对消费者id变化进行监听</span></span><br><span class="line">    <span class="built_in">this</span>.consumerManager = <span class="keyword">new</span> <span class="title class_">ConsumerManager</span>(<span class="built_in">this</span>.consumerIdsChangeListener);</span><br><span class="line">    <span class="comment">//消费者过滤管理器，配置文件为：xx/config/consumerFilter.json</span></span><br><span class="line">    <span class="built_in">this</span>.consumerFilterManager = <span class="keyword">new</span> <span class="title class_">ConsumerFilterManager</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//生产者管理器，包含生产者的注册信息，通过groupName分组</span></span><br><span class="line">    <span class="built_in">this</span>.producerManager = <span class="keyword">new</span> <span class="title class_">ProducerManager</span>();</span><br><span class="line">    <span class="comment">//客户端连接心跳服务，用于定时扫描生产者和消费者客户端，并将不活跃的客户端通道及相关信息移除</span></span><br><span class="line">    <span class="built_in">this</span>.clientHousekeepingService = <span class="keyword">new</span> <span class="title class_">ClientHousekeepingService</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//处理某些broker到客户端的请求，例如检查生产者的事务状态，重置offset</span></span><br><span class="line">    <span class="built_in">this</span>.broker2Client = <span class="keyword">new</span> <span class="title class_">Broker2Client</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//订阅分组关系管理器，维护消费者组的一些附加运维信息</span></span><br><span class="line">    <span class="built_in">this</span>.subscriptionGroupManager = messageStoreConfig.isEnableLmq() ? <span class="keyword">new</span> <span class="title class_">LmqSubscriptionGroupManager</span>(<span class="built_in">this</span>) : <span class="keyword">new</span> <span class="title class_">SubscriptionGroupManager</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//broker对方访问的API，处理broker对外的发起请求，比如向nameServer注册，向master、slave发起的请求</span></span><br><span class="line">    <span class="built_in">this</span>.brokerOuterAPI = <span class="keyword">new</span> <span class="title class_">BrokerOuterAPI</span>(nettyClientConfig);</span><br><span class="line">    <span class="comment">//过滤服务管理器，拉取消息过滤</span></span><br><span class="line">    <span class="built_in">this</span>.filterServerManager = <span class="keyword">new</span> <span class="title class_">FilterServerManager</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//用于从节点，定时向主节点发起请求同步数据，例如topic配置、消费位移等</span></span><br><span class="line">    <span class="built_in">this</span>.slaveSynchronize = <span class="keyword">new</span> <span class="title class_">SlaveSynchronize</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*初始化各种阻塞队列。将会被设置到对应的处理不同客户端请求的线程池执行器中*/</span></span><br><span class="line">    <span class="comment">//处理来自生产者的发送消息的请求的队列</span></span><br><span class="line">    <span class="built_in">this</span>.sendThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getSendThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//https://github.com/apache/rocketmq/pull/3631</span></span><br><span class="line">    <span class="built_in">this</span>.putThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getPutThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//处理来自消费者的拉取消息的请求的队列</span></span><br><span class="line">    <span class="built_in">this</span>.pullThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getPullThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//处理reply消息的请求的队列，RocketMQ4.7.0版本中增加了request-reply新特性，该特性允许producer在发送消息后同步或者异步等待consumer消费完消息并返回响应消息，类似rpc调用效果。</span></span><br><span class="line">    <span class="comment">//即生产者发送了消息之后，可以同步或者异步的收到消费了这条消息的消费者的响应</span></span><br><span class="line">    <span class="built_in">this</span>.replyThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getReplyThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//处理查询请求的队列</span></span><br><span class="line">    <span class="built_in">this</span>.queryThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getQueryThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//客户端管理器的队列</span></span><br><span class="line">    <span class="built_in">this</span>.clientManagerThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getClientManagerThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//消费者管理器的队列，目前没用到</span></span><br><span class="line">    <span class="built_in">this</span>.consumerManagerThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getConsumerManagerThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//心跳处理的队列</span></span><br><span class="line">    <span class="built_in">this</span>.heartbeatThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getHeartbeatThreadPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//事务消息相关处理的队列</span></span><br><span class="line">    <span class="built_in">this</span>.endTransactionThreadPoolQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="built_in">this</span>.brokerConfig.getEndTransactionPoolQueueCapacity());</span><br><span class="line">    <span class="comment">//broker状态管理器，保存Broker运行时状态</span></span><br><span class="line">    <span class="built_in">this</span>.brokerStatsManager = messageStoreConfig.isEnableLmq() ? <span class="keyword">new</span> <span class="title class_">LmqBrokerStatsManager</span>(<span class="built_in">this</span>.brokerConfig.getBrokerClusterName(), <span class="built_in">this</span>.brokerConfig.isEnableDetailStat()) : <span class="keyword">new</span> <span class="title class_">BrokerStatsManager</span>(<span class="built_in">this</span>.brokerConfig.getBrokerClusterName(), <span class="built_in">this</span>.brokerConfig.isEnableDetailStat());</span><br><span class="line">    <span class="comment">//目前没用到</span></span><br><span class="line">    <span class="built_in">this</span>.setStoreHost(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="built_in">this</span>.getBrokerConfig().getBrokerIP1(), <span class="built_in">this</span>.getNettyServerConfig().getListenPort()));</span><br><span class="line">    <span class="comment">//broker快速失败服务</span></span><br><span class="line">    <span class="built_in">this</span>.brokerFastFailure = <span class="keyword">new</span> <span class="title class_">BrokerFastFailure</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//配置类</span></span><br><span class="line">    <span class="built_in">this</span>.configuration = <span class="keyword">new</span> <span class="title class_">Configuration</span>(</span><br><span class="line">        log,</span><br><span class="line">        BrokerPathConfigHelper.getBrokerConfigPath(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig, <span class="built_in">this</span>.nettyServerConfig, <span class="built_in">this</span>.nettyClientConfig, <span class="built_in">this</span>.messageStoreConfig</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-初始化broker控制器"><a href="#2-3-初始化broker控制器" class="headerlink" title="2.3 初始化broker控制器"></a>2.3 初始化broker控制器</h3><p><strong>在实例化了BrokerController的对象之后，将会对其进行初始化。其主要步骤包括：</strong></p>
<p><strong>1、</strong> 加载config路径下的json配置文件，包括topic主题配置、offset消费偏移量、subscriptionGroup订阅分组、consumerFilter消费者过滤等配置文件；<br><strong>2、</strong><br>加载实例化消息存储相关类DefaultMessageStore，随后通过该类的load方法加载消息存储的相关文件，比如commitLog日志文件、consumequeue消息消费队列文件，indexFile索引文件，messageStore还会将这些文件的内容加载到内存中，并且完成RocketMQ的数据恢复这是broker启动的核心逻辑之一；</p>
<p><strong>大概步骤如下：</strong></p>
<p><strong>1、</strong> 加载配置文件：topic配置文件、消费者消费偏移量配置文件、订阅分组配置文件、消费者过滤配置文件；<br><strong>2、</strong> 实例化和初始化消息存储服务相关类DefaultMessageStore；<br><strong>3、</strong> 通过DefaultMessageStore加载消息存储的相关文件，比如commitLog日志文件、consumequeue消息消费队列文件、indexFile时间索引文件的加载，同时对于异常数据和文件进行销毁；<br><strong>4、</strong> 创建netty远程服务，包括remotingServer和fastRemotingServer；<br><strong>5、</strong> 调用registerProcessor方法注册netty消息处理器到netty远程服务中；<br><strong>6、</strong> 创建一系列定时任务，用于检查broker状态、统计接收、拉取消息数量、持久化消息文件、修改nameServer地址等；<br><strong>7、</strong> 调用initialTransaction初始化事务消息相关服务；<br><strong>8、</strong> 调用initialAcl初始化权限相关服务；<br><strong>9、</strong> 调用initialRpcHooks初始化所有RpcHook钩子；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 1 加载配置文件</span></span><br><span class="line"><span class="comment">     * 尝试从json配置文件或者bak备份文件中加载json字符串，然后反序列化转换为自身内部的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//topic配置文件加载，路径为  &#123;user.home&#125;/store/config/topics.json</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.topicConfigManager.load();</span><br><span class="line">    <span class="comment">//消费者消费偏移量配置文件加载，路径为  &#123;user.home&#125;/store/config/consumerOffset.json</span></span><br><span class="line">    result = result &amp;&amp; <span class="built_in">this</span>.consumerOffsetManager.load();</span><br><span class="line">    <span class="comment">//订阅分组配置文件加载，路径为  &#123;user.home&#125;/store/config/subscriptionGroup.json</span></span><br><span class="line">    result = result &amp;&amp; <span class="built_in">this</span>.subscriptionGroupManager.load();</span><br><span class="line">    <span class="comment">//消费者过滤配置文件加载，路径为  &#123;user.home&#125;/store/config/consumerFilter.json</span></span><br><span class="line">    result = result &amp;&amp; <span class="built_in">this</span>.consumerFilterManager.load();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 如果上一步加载配置全部成功</span></span><br><span class="line"><span class="comment">     * 2 实例化和初始化消息存储服务相关类DefaultMessageStore</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//实例化消息存储类DefaultMessageStore</span></span><br><span class="line">            <span class="built_in">this</span>.messageStore =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultMessageStore</span>(<span class="built_in">this</span>.messageStoreConfig, <span class="built_in">this</span>.brokerStatsManager, <span class="built_in">this</span>.messageArrivingListener,</span><br><span class="line">                            <span class="built_in">this</span>.brokerConfig);</span><br><span class="line">            <span class="comment">//如果启动了enableDLegerCommitLog，就创建DLeger组件DLedgerRoleChangeHandler。默认为false，如果需要开启则该值需要设置为true。</span></span><br><span class="line">            <span class="comment">//在启用enableDLegerCommitLog情况下，broker通过raft协议选主，可以实现主从角色自动切换，这是4.5版本之后的新功能</span></span><br><span class="line">            <span class="comment">//简单的说，如果启动enableDLegerCommitLog，就表示启用 RocketMQ 的容灾机制——自动主从切换，</span></span><br><span class="line">            <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="type">DLedgerRoleChangeHandler</span> <span class="variable">roleChangeHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DLedgerRoleChangeHandler</span>(<span class="built_in">this</span>, (DefaultMessageStore) messageStore);</span><br><span class="line">                ((DLedgerCommitLog) ((DefaultMessageStore) messageStore).getCommitLog()).getdLedgerServer().getdLedgerLeaderElector().addRoleChangeHandler(roleChangeHandler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//broker的统计服务类，保存了broker的一些统计数据</span></span><br><span class="line">            <span class="comment">//例如msgPutTotalTodayNow --现在存储的消息数量，msgPutTotalTodayMorning --今天存储的消息数量</span></span><br><span class="line">            <span class="built_in">this</span>.brokerStats = <span class="keyword">new</span> <span class="title class_">BrokerStats</span>((DefaultMessageStore) <span class="built_in">this</span>.messageStore);</span><br><span class="line">            <span class="comment">//load plugin</span></span><br><span class="line">            <span class="comment">//加载存在的消息存储插件，不必深究</span></span><br><span class="line">            <span class="type">MessageStorePluginContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageStorePluginContext</span>(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">            <span class="built_in">this</span>.messageStore = MessageStoreFactory.build(context, <span class="built_in">this</span>.messageStore);</span><br><span class="line">            <span class="comment">//添加一个针对布隆过滤器的消费过滤类</span></span><br><span class="line">            <span class="built_in">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> <span class="title class_">CommitLogDispatcherCalcBitMap</span>(<span class="built_in">this</span>.brokerConfig, <span class="built_in">this</span>.consumerFilterManager));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            result = <span class="literal">false</span>;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to initialize&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 如果上一步加载配置全部成功</span></span><br><span class="line"><span class="comment">     * 3 通过消息存储服务加载消息存储的相关文件，比如commitLog日志文件、consumequeue消息消费队列文件的加载，indexFile索引文件的构建</span></span><br><span class="line"><span class="comment">     * messageStore还会将这些文件的内容加载到内存中，并且完成RocketMQ的数据恢复</span></span><br><span class="line"><span class="comment">     * 这是核broker启动的心步骤之一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    result = result &amp;&amp; <span class="built_in">this</span>.messageStore.load();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 如果上一步加载配置全部成功</span></span><br><span class="line"><span class="comment">     * 3 开始初始化Broker通信层和各种请求执行器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 4 创建netty远程服务，remotingServer和fastRemotingServer</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//创建broker的netty远程服务，端口为10911，可以用于处理客户端的所有请求。</span></span><br><span class="line">        <span class="built_in">this</span>.remotingServer = <span class="keyword">new</span> <span class="title class_">NettyRemotingServer</span>(<span class="built_in">this</span>.nettyServerConfig, <span class="built_in">this</span>.clientHousekeepingService);</span><br><span class="line">        <span class="comment">//创建一个broker的netty快速远程服务的配置</span></span><br><span class="line">        <span class="type">NettyServerConfig</span> <span class="variable">fastConfig</span> <span class="operator">=</span> (NettyServerConfig) <span class="built_in">this</span>.nettyServerConfig.clone();</span><br><span class="line">        <span class="comment">//设置快速netty远程服务的配置监听的端口号为普通服务的端口-2，默认10909</span></span><br><span class="line">        fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//创建broker的netty快速服务，这就是所谓的快速通道，对应可以处理客户端除了拉取消息之外的所有请求，所谓的VIP端口。</span></span><br><span class="line">        <span class="built_in">this</span>.fastRemotingServer = <span class="keyword">new</span> <span class="title class_">NettyRemotingServer</span>(fastConfig, <span class="built_in">this</span>.clientHousekeepingService);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 5 创建各种执行器线程池</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//处理发送消息的请求的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.sendMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.sendThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;SendMessageThread_&quot;</span>));</span><br><span class="line">        <span class="comment">///https://github.com/apache/rocketmq/pull/3631</span></span><br><span class="line">        <span class="built_in">this</span>.putMessageFutureExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getPutMessageFutureThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getPutMessageFutureThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.putThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;PutMessageThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//处理拉取消息的请求的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.pullMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.pullThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;PullMessageThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//处理reply消息的请求的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.replyMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.replyThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;ProcessReplyMessageThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//处理查询请求的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.queryMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.queryThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;QueryMessageThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//broker 管理线程池，作为默认处理器的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.adminBrokerExecutor =</span><br><span class="line">                Executors.newFixedThreadPool(<span class="built_in">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(</span><br><span class="line">                        <span class="string">&quot;AdminBrokerThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//客户端管理器的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.clientManageExecutor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.clientManagerThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;ClientManageThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//心跳处理的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.heartbeatExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.heartbeatThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;HeartbeatThread_&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">        <span class="comment">//事务消息相关处理的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.endTransactionExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">                <span class="built_in">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="built_in">this</span>.endTransactionThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;EndTransactionThread_&quot;</span>));</span><br><span class="line">        <span class="comment">//消费者管理的线程池</span></span><br><span class="line">        <span class="built_in">this</span>.consumerManageExecutor =</span><br><span class="line">                Executors.newFixedThreadPool(<span class="built_in">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(</span><br><span class="line">                        <span class="string">&quot;ConsumerManageThread_&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 6 注册处理器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.registerProcessor();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 7 启动一系列定时周期任务</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">initialDelay</span> <span class="operator">=</span> UtilAll.computeNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//每隔24h打印昨天生产和消费的消息数量</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">period</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    BrokerController.<span class="built_in">this</span>.getBrokerStats().record();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;schedule record error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">//每隔5s將消费者offset进行持久化，存入consumerOffset.json文件中</span></span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    BrokerController.<span class="built_in">this</span>.consumerOffsetManager.persist();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;schedule persist consumerOffset error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="built_in">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">//每隔10s將消费过滤信息进行持久化，存入consumerFilter.json文件中</span></span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    BrokerController.<span class="built_in">this</span>.consumerFilterManager.persist();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;schedule persist consumer filter error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">//每隔3m將检查消费者的消费进度</span></span><br><span class="line">        <span class="comment">//当消费进度落后阈值的时候，并且disableConsumeIfConsumerReadSlowly=true(默认false)，就停止消费者消费，保护broker，避免消费积压</span></span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    BrokerController.<span class="built_in">this</span>.protectBroker();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;protectBroker error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//每隔1s將打印发送消息线程池队列、拉取消息线程池队列、查询消息线程池队列、结束事务线程池队列的大小以及队列头部元素存在时间</span></span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    BrokerController.<span class="built_in">this</span>.printWaterMark();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;printWaterMark error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//每隔1m將打印已存储在commitlog提交日志中但尚未分派到consume queue消费队列的字节数。</span></span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.info(<span class="string">&quot;dispatch behind commit log &#123;&#125; bytes&quot;</span>, BrokerController.<span class="built_in">this</span>.getMessageStore().dispatchBehindBytes());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;schedule dispatchBehindBytes error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果broker的nameServer地址不为null</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.brokerConfig.getNamesrvAddr() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//更新nameServer地址</span></span><br><span class="line">            <span class="built_in">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="built_in">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">            log.info(<span class="string">&quot;Set user specified name server address: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//如果没有指定nameServer地址，并且允许从地址服务器获取nameServer地址</span></span><br><span class="line">            <span class="comment">//那么每隔2m从nameServer地址服务器拉取最新的nameServer地址并更新</span></span><br><span class="line">            <span class="comment">//要想动态更新nameServer地址，需要指定一个地址服务器的url，并且fetchNamesrvAddrByAddressServer设置为true</span></span><br><span class="line">            <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                        BrokerController.<span class="built_in">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                        log.error(<span class="string">&quot;ScheduledTask fetchNameServerAddr exception&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有开启DLeger服务，DLeger开启后表示支持高可用的主从自动切换</span></span><br><span class="line">        <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//如果当前broker是slave从节点</span></span><br><span class="line">            <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="built_in">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//根据是否配置了HA地址，来更新HA地址，并设置updateMasterHAServerAddrPeriodically</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    <span class="built_in">this</span>.messageStore.updateHaMasterAddress(<span class="built_in">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                    <span class="built_in">this</span>.updateMasterHAServerAddrPeriodically = <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    <span class="built_in">this</span>.updateMasterHAServerAddrPeriodically = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//如果是主节点，每隔60s將打印主从节点的差异</span></span><br><span class="line">                <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                            BrokerController.<span class="built_in">this</span>.printMasterAndSlaveDiff();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                            log.error(<span class="string">&quot;schedule printMasterAndSlaveDiff error.&quot;</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Tls传输相关配置，通信安全的文件监听模块，用来观察网络加密配置文件的更改</span></span><br><span class="line">        <span class="comment">//默认是PERMISSIVE，因此会进入代码块</span></span><br><span class="line">        <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">// Register a listener to reload SslContext</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//实例化文件监听服务,并且初始化事务消息服务。</span></span><br><span class="line">                fileWatchService = <span class="keyword">new</span> <span class="title class_">FileWatchService</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                TlsSystemConfig.tlsServerCertPath,</span><br><span class="line">                                TlsSystemConfig.tlsServerKeyPath,</span><br><span class="line">                                TlsSystemConfig.tlsServerTrustCertPath</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">FileWatchService</span>.Listener() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                            <span class="type">boolean</span> certChanged, keyChanged = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChanged</span><span class="params">(String path)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerTrustCertPath)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                    log.info(<span class="string">&quot;The trust certificate changed, reload the ssl context&quot;</span>);</span><br><span class="line">                                    reloadServerSslContext();</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerCertPath)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                    certChanged = <span class="literal">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerKeyPath)) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                    keyChanged = <span class="literal">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (certChanged &amp;&amp; keyChanged) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                    log.info(<span class="string">&quot;The certificate and private key changed, reload the ssl context&quot;</span>);</span><br><span class="line">                                    certChanged = keyChanged = <span class="literal">false</span>;</span><br><span class="line">                                    reloadServerSslContext();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reloadServerSslContext</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                                ((NettyRemotingServer) remotingServer).loadSslContext();</span><br><span class="line">                                ((NettyRemotingServer) fastRemotingServer).loadSslContext();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                log.warn(<span class="string">&quot;FileWatchService created error, can&#x27;t load the certificate dynamically&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 8 初始化事务消息相关服务</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initialTransaction();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 9 初始化权限相关服务</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initialAcl();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 10 初始化RPC调用的钩子函数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initialRpcHooks();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-1-加载配置文件"><a href="#2-3-1-加载配置文件" class="headerlink" title="2.3.1 加载配置文件"></a>2.3.1 加载配置文件</h4><p>首先会用过四个load方法加载配置文件：</p>
<p><strong>1、</strong> <strong>topic配置文件加载</strong><br>，路径为{user.home}&#x2F;store&#x2F;config&#x2F;topics.json配置会被存入topicConfigManager的topicConfigTable这个ConcurrentMap&lt;<br>String,TopicConfig&gt;类型的属性中；<br><strong>2、</strong><br>消费者消费偏移量配置文件加载，路径为{user.home}&#x2F;store&#x2F;config&#x2F;consumerOffset.json配置会被存入consumerOffsetManager的offsetTable这个ConcurrentMap&lt;<br>String&#x2F;*topic@group*&#x2F;,ConcurrentMap&lt;Integer,Long&gt;&gt;类型的属性中；<br><strong>3、</strong> <strong>订阅分组配置文件加载</strong><br>，路径为{user.home}&#x2F;store&#x2F;config&#x2F;subscriptionGroup.json配置会被存入subscriptionGroupManager的subscriptionGroupTable这个ConcurrentMap&lt;<br>String,SubscriptionGroupConfig&gt;类型的属性中；<br><strong>4、</strong> <strong>消费者过滤配置文件加载</strong><br>，路径为{user.home}&#x2F;store&#x2F;config&#x2F;consumerFilter.json配置会被存入consumerFilterManager的filterDataByTopic这个ConcurrentMap&lt;<br>String&#x2F;Topic&#x2F;,FilterDataMapByTopic&gt;类型的属性中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ConfigManager的方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//配置文件路径</span></span><br><span class="line">        fileName = <span class="built_in">this</span>.configFilePath();</span><br><span class="line">        <span class="comment">//加载配置文件得到内部的json字符串数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> MixAll.file2String(fileName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == jsonString || jsonString.length() == <span class="number">0</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//如果加载的json字符串为空，那么转而加载bak备份文件</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.loadBak();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">//如果加载的json字符串不为空，那么将json字符串反序列化为对象属性</span></span><br><span class="line">            <span class="built_in">this</span>.decode(jsonString);</span><br><span class="line">            log.info(<span class="string">&quot;load &quot;</span> + fileName + <span class="string">&quot; OK&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        log.error(<span class="string">&quot;load &quot;</span> + fileName + <span class="string">&quot; failed, and try to load backup file&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.loadBak();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-创建消息存储对象MessageStore"><a href="#2-3-2-创建消息存储对象MessageStore" class="headerlink" title="2.3.2 创建消息存储对象MessageStore"></a>2.3.2 创建消息存储对象MessageStore</h4><p>如果上面的四个文件都加载成功，则创建负责消息存储文件相关的对象<br>DefaultMessageStore。注意，这里所谓的加载成功，是指在加在过程中没有抛出异常，即使是没有对应的文件和临时文件，只要没抛出异常，也会返回true，表示加载成功。</p>
<ul>
<li>*DefaultMessageStore是RocketMQ的核心文件存储控制类，是RocketMQ对于消息存储和获取功能的抽象。DefaultMessageStore类位于store模块，通过该类可以直接控制管理commitLog、consumeQueue、indexFile等文件内容的读、写，非常重要。<br>**</li>
</ul>
<p><strong>在启动Broker的时候，就会创建一个DefaultMessageStore对象，随后会通过load方法进行磁盘文件的加载和异常数据的修复。</strong></p>
<ul>
<li>*先看看它的构造器，看起来比较简单，会进行各种实例化操作。这里面会对一些关键类和服务进行实例化，例如锁文件lockFile，创建和预热MappedFile文件的服务allocateMappedFileService，各种消息文件刷盘或者清理服务，延迟消息处理服务scheduleMessageService等等，这些服务内部都有一个独立的线程用于执行各自的操作。<br>**</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultMessageStore</span><span class="params">(<span class="keyword">final</span> MessageStoreConfig messageStoreConfig, <span class="keyword">final</span> BrokerStatsManager </span></span><br><span class="line"><span class="params">brokerStatsManager,</span></span><br><span class="line"><span class="params">                             <span class="keyword">final</span> MessageArrivingListener messageArrivingListener, <span class="keyword">final</span> BrokerConfig brokerConfig)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">      <span class="comment">//消息送达的监听器，生产者消息到达时通过该监听器触发pullRequestHoldService通知pullRequestHoldService</span></span><br><span class="line">      <span class="built_in">this</span>.messageArrivingListener = messageArrivingListener;</span><br><span class="line">      <span class="comment">//Broker的配置类，包含Broker的各种配置，比如ROCKETMQ_HOME</span></span><br><span class="line">      <span class="built_in">this</span>.brokerConfig = brokerConfig;</span><br><span class="line">      <span class="comment">//Broker的消息存储配置，例如各种文件大小等</span></span><br><span class="line">      <span class="built_in">this</span>.messageStoreConfig = messageStoreConfig;</span><br><span class="line">      <span class="comment">//broker状态管理器，保存Broker运行时状态，统计工作</span></span><br><span class="line">      <span class="built_in">this</span>.brokerStatsManager = brokerStatsManager;</span><br><span class="line">      <span class="comment">//创建 MappedFile文件的服务，用于初始化MappedFile和预热MappedFile</span></span><br><span class="line">      <span class="built_in">this</span>.allocateMappedFileService = <span class="keyword">new</span> <span class="title class_">AllocateMappedFileService</span>(<span class="built_in">this</span>);</span><br><span class="line">      <span class="comment">//实例化CommitLog，DLedgerCommitLog表示主持主从自动切换功能，默认是CommitLog类型</span></span><br><span class="line">      <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">          <span class="built_in">this</span>.commitLog = <span class="keyword">new</span> <span class="title class_">DLedgerCommitLog</span>(<span class="built_in">this</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">          <span class="built_in">this</span>.commitLog = <span class="keyword">new</span> <span class="title class_">CommitLog</span>(<span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//topic的ConsumeQueueMap的对应关系</span></span><br><span class="line">      <span class="built_in">this</span>.consumeQueueTable = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">32</span>);</span><br><span class="line">      <span class="comment">//ConsumeQueue文件的刷盘服务</span></span><br><span class="line">      <span class="built_in">this</span>.flushConsumeQueueService = <span class="keyword">new</span> <span class="title class_">FlushConsumeQueueService</span>();</span><br><span class="line">      <span class="comment">//清除过期CommitLog文件的服务</span></span><br><span class="line">      <span class="built_in">this</span>.cleanCommitLogService = <span class="keyword">new</span> <span class="title class_">CleanCommitLogService</span>();</span><br><span class="line">      <span class="comment">//清除过期ConsumeQueue文件的服务</span></span><br><span class="line">      <span class="built_in">this</span>.cleanConsumeQueueService = <span class="keyword">new</span> <span class="title class_">CleanConsumeQueueService</span>();</span><br><span class="line">      <span class="comment">//存储一些统计指标信息的服务</span></span><br><span class="line">      <span class="built_in">this</span>.storeStatsService = <span class="keyword">new</span> <span class="title class_">StoreStatsService</span>();</span><br><span class="line">      <span class="comment">//IndexFile索引文件服务</span></span><br><span class="line">      <span class="built_in">this</span>.indexService = <span class="keyword">new</span> <span class="title class_">IndexService</span>(<span class="built_in">this</span>);</span><br><span class="line">      <span class="comment">//高可用服务，默认为null</span></span><br><span class="line">      <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">          <span class="built_in">this</span>.haService = <span class="keyword">new</span> <span class="title class_">HAService</span>(<span class="built_in">this</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">          <span class="built_in">this</span>.haService = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//根据CommitLog文件，更新index文件索引和ConsumeQueue文件偏移量的服务</span></span><br><span class="line">      <span class="built_in">this</span>.reputMessageService = <span class="keyword">new</span> <span class="title class_">ReputMessageService</span>();</span><br><span class="line">      <span class="comment">//处理RocketMQ延迟消息的服务</span></span><br><span class="line">      <span class="built_in">this</span>.scheduleMessageService = <span class="keyword">new</span> <span class="title class_">ScheduleMessageService</span>(<span class="built_in">this</span>);</span><br><span class="line">      <span class="comment">//初始化MappedFile的时候进行ByteBuffer的分配回收</span></span><br><span class="line">      <span class="built_in">this</span>.transientStorePool = <span class="keyword">new</span> <span class="title class_">TransientStorePool</span>(messageStoreConfig);</span><br><span class="line">      <span class="comment">//如果当前节点不是从节点，并且是异步刷盘策略，并且transientStorePoolEnable参数配置为true，则启动该服务</span></span><br><span class="line">      <span class="keyword">if</span> (messageStoreConfig.isTransientStorePoolEnable()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">          <span class="built_in">this</span>.transientStorePool.init();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//启动MappedFile文件服务线程</span></span><br><span class="line">      <span class="built_in">this</span>.allocateMappedFileService.start();</span><br><span class="line">      <span class="comment">//启动index索引文件服务线程</span></span><br><span class="line">      <span class="built_in">this</span>.indexService.start();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//转发服务列表，监听CommitLog文件中的新消息存储，然后会调用列表中的CommitLogDispatcher#dispatch方法</span></span><br><span class="line">      <span class="built_in">this</span>.dispatcherList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">      <span class="comment">//通知ConsumeQueue的Dispatcher，可用于更新ConsumeQueue的偏移量等信息</span></span><br><span class="line">      <span class="built_in">this</span>.dispatcherList.addLast(<span class="keyword">new</span> <span class="title class_">CommitLogDispatcherBuildConsumeQueue</span>());</span><br><span class="line">      <span class="comment">//通知IndexFile的Dispatcher，可用于更新IndexFile的时间戳等信息</span></span><br><span class="line">      <span class="built_in">this</span>.dispatcherList.addLast(<span class="keyword">new</span> <span class="title class_">CommitLogDispatcherBuildIndex</span>());</span><br><span class="line">      <span class="comment">//获取锁文件，路径就是配置的&#123;storePathRootDir&#125;/lock</span></span><br><span class="line">      <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(StorePathConfigHelper.getLockFile(messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">      <span class="comment">//确保创建file文件的父目录，即&#123;storePathRootDir&#125;目录</span></span><br><span class="line">      MappedFile.ensureDirOK(file.getParent());</span><br><span class="line">      <span class="comment">//确保创建commitlog目录，即&#123;StorePathCommitLog&#125;目录</span></span><br><span class="line">      MappedFile.ensureDirOK(getStorePathPhysic());</span><br><span class="line">      <span class="comment">//确保创建consumequeue目录，即&#123;storePathRootDir&#125;/consumequeue目录</span></span><br><span class="line">      MappedFile.ensureDirOK(getStorePathLogic());</span><br><span class="line">      <span class="comment">//创建lockfile文件，名为lock，权限是&quot;读写&quot;，这是一个锁文件，用于获取文件锁。</span></span><br><span class="line"><span class="comment">//文件锁用来保证磁盘上的这些存储文件同时只能有一个Broker的messageStore来操作。</span></span><br><span class="line">      lockFile = <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-Load加载恢复消息文件"><a href="#2-3-3-Load加载恢复消息文件" class="headerlink" title="2.3.3 Load加载恢复消息文件"></a>2.3.3 Load加载恢复消息文件</h4><p>**DefaultMessageStore实例化之后，将会调用load方法将磁盘中的commitLog、ConsumeQueue、IndexFile文件的数据加载到内存中，还会进行数据恢复操作。<br>**</p>
<p>主要步骤为：</p>
<p><strong>1、</strong> 调用isTempFileExist方法判断上次broker是否是正常退出，如果是正常退出不会保留abort文件，异常退出则会；<br><strong>2、</strong> 加载CommitLog日志文件CommitLog文件是真正存储消息内容的地方；<br><strong>3、</strong> 加载ConsumeQueue文件ConsumeQueue文件可以看作是CommitLog的消息偏移量索引文件；<br><strong>4、</strong> 加载index索引文件Index文件可以看作是CommitLog的消息时间范围索引文件；<br><strong>5、</strong> 恢复ConsumeQueue文件和CommitLog文件，将正确的的数据恢复至内存中，删除错误数据和文件；<br><strong>6、</strong> 加载RocketMQ延迟消息的服务，包括延时等级、配置文件等等；</p>
<p><strong>这里我们仅介绍大概流程，关于详细源码分析，我们将会放在下一篇文章中单独分析。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DefaultMessageStore的方法</span></span><br><span class="line"><span class="comment"> * 加载Commit Log、Consume Queue、index file等文件，将数据加载到内存中，并完成数据的恢复</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 1 判断上次broker是否是正常退出，如果是正常退出不会保留abort文件，异常退出则会</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Broker在启动时会创建&#123;storePathRootDir&#125;/abort文件，并且注册钩子函数：在JVM退出时删除abort文件。</span></span><br><span class="line"><span class="comment">         * 如果下一次启动时存在abort文件，说明Broker是异常退出的，文件数据可能不一直，需要进行数据修复。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lastExitOK</span> <span class="operator">=</span> !<span class="built_in">this</span>.isTempFileExist();</span><br><span class="line">        log.info(<span class="string">&quot;last shutdown &#123;&#125;&quot;</span>, lastExitOK ? <span class="string">&quot;normally&quot;</span> : <span class="string">&quot;abnormally&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 2 加载Commit Log日志文件，目录路径取自broker.conf文件中的storePathCommitLog属性</span></span><br><span class="line"><span class="comment">         * Commit Log文件是真正存储消息内容的地方，单个文件默认大小1G。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// load Commit Log</span></span><br><span class="line">        result = result &amp;&amp; <span class="built_in">this</span>.commitLog.load();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 2 加载Consume Queue文件，目录路径为&#123;storePathRootDir&#125;/consumequeue，文件组织方式为topic/queueId/fileName</span></span><br><span class="line"><span class="comment">         * Consume Queue文件可以看作是Commit Log的索引文件，其存储了它所属Topic的消息在Commit Log中的偏移量</span></span><br><span class="line"><span class="comment">         * 消费者拉取消息的时候，可以从Consume Queue中快速的根据偏移量定位消息在Commit Log中的位置。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// load Consume Queue</span></span><br><span class="line">        result = result &amp;&amp; <span class="built_in">this</span>.loadConsumeQueue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 3 加载checkpoint 检查点文件，文件位置是&#123;storePathRootDir&#125;/checkpoint</span></span><br><span class="line"><span class="comment">             * StoreCheckpoint记录着commitLog、ConsumeQueue、Index文件的最后更新时间点，</span></span><br><span class="line"><span class="comment">             * 当上一次broker是异常结束时，会根据StoreCheckpoint的数据进行恢复，这决定着文件从哪里开始恢复，甚至是删除文件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">this</span>.storeCheckpoint =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">StoreCheckpoint</span>(StorePathConfigHelper.getStoreCheckpoint(<span class="built_in">this</span>.messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 4 加载 index 索引文件，目录路径为&#123;storePathRootDir&#125;/index</span></span><br><span class="line"><span class="comment">             * index 索引文件用于通过时间区间来快速查询消息，底层为HashMap结构，实现为hash索引。后面会专门出文介绍</span></span><br><span class="line"><span class="comment">             * 如果不是正常退出，并且最大更新时间戳比checkpoint文件中的时间戳大，则删除该 index 文件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">this</span>.indexService.load(lastExitOK);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 4 恢复ConsumeQueue文件和CommitLog文件，将正确的的数据恢复至内存中，删除错误数据和文件。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">this</span>.recover(lastExitOK);</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;load over, and the max phy offset = &#123;&#125;&quot;</span>, <span class="built_in">this</span>.getMaxPhyOffset());</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 5 加载RocketMQ延迟消息的服务，包括延时等级、配置文件等等。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != scheduleMessageService) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                result = <span class="built_in">this</span>.scheduleMessageService.load();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        log.error(<span class="string">&quot;load exception&quot;</span>, e);</span><br><span class="line">        result = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//如果上面的操作抛出异常，则文件服务停止</span></span><br><span class="line">        <span class="built_in">this</span>.allocateMappedFileService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-4-初始化Broker通信层"><a href="#2-3-4-初始化Broker通信层" class="headerlink" title="2.3.4 初始化Broker通信层"></a>2.3.4 初始化Broker通信层</h4><p><strong>在配置文件和各种日志文件加载、恢复完毕之后，开始初始化Broker通信层和各种请求执行器。</strong></p>
<p>**首先会创建两个NettyRemotingServer，分别是普通的远程服务remotingServer，默认端口为10911，以及快速远程服务fastRemotingServer，端口号是普通服务的端口号-2，默认10909。<br>**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建broker的netty远程服务，端口为10911，可以用于处理客户端的所有请求。</span></span><br><span class="line"><span class="built_in">this</span>.remotingServer = <span class="keyword">new</span> <span class="title class_">NettyRemotingServer</span>(<span class="built_in">this</span>.nettyServerConfig, <span class="built_in">this</span>.clientHousekeepingService);</span><br><span class="line"><span class="comment">//创建一个broker的netty快速远程服务的配置</span></span><br><span class="line"><span class="type">NettyServerConfig</span> <span class="variable">fastConfig</span> <span class="operator">=</span> (NettyServerConfig) <span class="built_in">this</span>.nettyServerConfig.clone();</span><br><span class="line"><span class="comment">//设置快速netty远程服务的配置监听的端口号为普通服务的端口-2，默认10909</span></span><br><span class="line">fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line"><span class="comment">//创建broker的netty快速服务，这就是所谓的快速通道，对应可以处理客户端除了拉取消息之外的所有请求，所谓的VIP端口。</span></span><br><span class="line"><span class="built_in">this</span>.fastRemotingServer = <span class="keyword">new</span> <span class="title class_">NettyRemotingServer</span>(fastConfig, <span class="built_in">this</span>.clientHousekeepingService);</span><br></pre></td></tr></table></figure>

<h4 id="2-3-5-创建各种执行器线程池"><a href="#2-3-5-创建各种执行器线程池" class="headerlink" title="2.3.5 创建各种执行器线程池"></a>2.3.5 创建各种执行器线程池</h4><p><strong>这一步创建很多个线程池，因为RocketMQ为了性能，将许多的请求的进行异步化处理，因此需要多个线程池。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 5 创建各种执行器线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//处理发送消息的请求的线程池</span></span><br><span class="line"><span class="built_in">this</span>.sendMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.sendThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;SendMessageThread_&quot;</span>));</span><br><span class="line"><span class="comment">///https://github.com/apache/rocketmq/pull/3631</span></span><br><span class="line"><span class="built_in">this</span>.putMessageFutureExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getPutMessageFutureThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getPutMessageFutureThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.putThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;PutMessageThread_&quot;</span>));</span><br><span class="line"><span class="comment">//处理拉取消息的请求的线程池</span></span><br><span class="line"><span class="built_in">this</span>.pullMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.pullThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;PullMessageThread_&quot;</span>));</span><br><span class="line"><span class="comment">//处理reply消息的请求的线程池</span></span><br><span class="line"><span class="built_in">this</span>.replyMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.replyThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;ProcessReplyMessageThread_&quot;</span>));</span><br><span class="line"><span class="comment">//处理查询请求的线程池</span></span><br><span class="line"><span class="built_in">this</span>.queryMessageExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.queryThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;QueryMessageThread_&quot;</span>));</span><br><span class="line"><span class="comment">//broker 管理线程池，作为默认处理器的线程池</span></span><br><span class="line"><span class="built_in">this</span>.adminBrokerExecutor =</span><br><span class="line">        Executors.newFixedThreadPool(<span class="built_in">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(</span><br><span class="line">                <span class="string">&quot;AdminBrokerThread_&quot;</span>));</span><br><span class="line"><span class="comment">//客户端管理器的线程池</span></span><br><span class="line"><span class="built_in">this</span>.clientManageExecutor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.clientManagerThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;ClientManageThread_&quot;</span>));</span><br><span class="line"><span class="comment">//心跳处理的线程池</span></span><br><span class="line"><span class="built_in">this</span>.heartbeatExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.heartbeatThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;HeartbeatThread_&quot;</span>, <span class="literal">true</span>));</span><br><span class="line"><span class="comment">//事务消息相关处理的线程池</span></span><br><span class="line"><span class="built_in">this</span>.endTransactionExecutor = <span class="keyword">new</span> <span class="title class_">BrokerFixedThreadPoolExecutor</span>(</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">        <span class="built_in">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">        <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="built_in">this</span>.endTransactionThreadPoolQueue,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;EndTransactionThread_&quot;</span>));</span><br><span class="line"><span class="comment">//消费者管理的线程池</span></span><br><span class="line"><span class="built_in">this</span>.consumerManageExecutor =</span><br><span class="line">        Executors.newFixedThreadPool(<span class="built_in">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(</span><br><span class="line">                <span class="string">&quot;ConsumerManageThread_&quot;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="2-3-6-注册netty消息处理器"><a href="#2-3-6-注册netty消息处理器" class="headerlink" title="2.3.6 注册netty消息处理器"></a>2.3.6 注册netty消息处理器</h4><p>**RocketMQ底层通信基于netty，这里注册netty请求处理器。当对应类型的请求到达broker服务端的时候，便会由对应的消息处理器进行处理。<br>**</p>
<p><strong>registerProcessor方法中的所有的处理器都是通过remotingServer #registerProcessor方法进行注册的。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrokerController的方法</span></span><br><span class="line"><span class="comment"> * 注册netty消息处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">SendMessageProcessor</span> <span class="variable">sendProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SendMessageProcessor</span>(<span class="built_in">this</span>);</span><br><span class="line">    sendProcessor.registerSendMessageHook(sendMessageHookList);</span><br><span class="line">    sendProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于发送类型的请求，使用发送消息处理器sendProcessor来处理</span></span><br><span class="line">    <span class="built_in">this</span>.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.remotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.remotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="built_in">this</span>.fastRemotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, <span class="built_in">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="comment">//……………………省略其他处理器的注册</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>*该方法将会注册SendMessageProcessor、pullMessageExecutor、ReplyMessageProcessor、QueryMessageProcessor、ClientManageProcessor、ConsumerManageProcessor、EndTransactionProcessor、AdminBrokerProcessor这几个处理器。<br>**</p>
</li>
<li><p>*除了pullMessageProcessor处理器只会被注册到remotingServer之外，其他处理器会被注册到remotingServer和fastRemotingServer这两个netty服务中。从这里的源码能够看出来，Vip通道服务不能够处理拉取消息的请求。<br>**</p>
</li>
</ul>
<h5 id="2-3-6-1-registerProcessor注册处理器"><a href="#2-3-6-1-registerProcessor注册处理器" class="headerlink" title="2.3.6.1 registerProcessor注册处理器"></a>2.3.6.1 registerProcessor注册处理器</h5><ul>
<li>*remotingServer#registerProcessor方法的源码也比较简单。该方法将处理器和对应的线程池绑定为一个Pair对象，并且将这个pair对象放入processorTable中，其值就是pair对象，key就是对应的请求编码RequestCode。<br>**</li>
</ul>
<p>**每个请求，都会根据自己携带的RequestCode在processorTable中查找对应的处理器以及对应的执行器线程池来处理请求。RocketMQ通过这样的方式来提升处理请求的性能。<br>**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * NettyRemotingServer的方法，注册netty请求处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestCode 请求编码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> processor 请求处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executor 请求执行器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerProcessor</span><span class="params">(<span class="type">int</span> requestCode, NettyRequestProcessor processor, ExecutorService executor)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorThis</span> <span class="operator">=</span> executor;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == executor) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//默认执行器是publicExecutor，线程数默认4个线程，线程名以NettyServerPublicExecutor_为前缀。</span></span><br><span class="line">        executorThis = <span class="built_in">this</span>.publicExecutor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构建Pair对象</span></span><br><span class="line">    Pair&lt;NettyRequestProcessor, ExecutorService&gt; pair = <span class="keyword">new</span> <span class="title class_">Pair</span>&lt;NettyRequestProcessor, ExecutorService&gt;(processor, executorThis);</span><br><span class="line">    <span class="comment">//存入nettyremotingServer的processorTable属性中</span></span><br><span class="line">    <span class="built_in">this</span>.processorTable.put(requestCode, pair);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>位于NettyRemotingAbstract中的processorTable属性：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This container holds all processors per request code, aka, for each incoming request, we may look up the</span></span><br><span class="line"><span class="comment"> * responding processor in this map to handle the request.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 这个容器包含每个请求代码（aka）的所有处理器。对于每个传入的请求，我们可以在这个映射中查找响应的处理器来处理请求。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HashMap&lt;Integer<span class="comment">/* request code */</span>, Pair&lt;NettyRequestProcessor, ExecutorService&gt;&gt; processorTable =</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer, Pair&lt;NettyRequestProcessor, ExecutorService&gt;&gt;(<span class="number">64</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-3-7-启动定时周期任务"><a href="#2-3-7-启动定时周期任务" class="headerlink" title="2.3.7 启动定时周期任务"></a>2.3.7 启动定时周期任务</h4><p>在注册了netty消息处理器之后，将会启动一系列的定时任务。这些定时任务由BrokerController中的scheduledExecutorService去执行，该线程池只有一个线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">scheduledExecutorService</span> <span class="operator">=</span> </span><br><span class="line">Executors.newSingleThreadScheduledExecutor(<span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(</span><br><span class="line">        <span class="string">&quot;BrokerControllerScheduledThread&quot;</span>));</span><br></pre></td></tr></table></figure>

<p><strong>启动的定时任务如下：</strong></p>
<p><strong>1、</strong> 每隔24h打印昨天生产和消费的消息数量；<br><strong>2、</strong> 每隔5s將消费者offset进行持久化，存入consumerOffset.json文件中；<br><strong>3、</strong> 每隔10s將消费过滤信息进行持久化，存入consumerFilter.json文件中；<br><strong>4、</strong> 每隔3m將检查消费者的消费进度当消费进度落后阈值的时候，并且disableConsumeIfConsumerReadSlowly&#x3D;true(默认false)<br>，就停止消费者消费，保护broker，避免消费积压；<br><strong>5、</strong> 每隔1s將打印发送消息线程池队列、拉取消息线程池队列、查询消息线程池队列、结束事务线程池队列的大小以及队列头部元素存在时间；<br><strong>6、</strong> 每隔1m將打印已存储在commitlog提交日志中但尚未分派到consumequeue消费队列的字节数；<br><strong>7、</strong> 如果broker手动设置的nameServer地址为null，并且并且允许从地址服务器获取nameServer地址，那么每隔2m从nameServer地址服务器拉取最新的nameServer地址并更新；<br><strong>8、</strong> 如果没有开启DLeger服务，如果是主节点，每隔60s將打印主从节点的差异；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 7 启动一系列定时周期任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">initialDelay</span> <span class="operator">=</span> UtilAll.computeNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line"><span class="comment">//每隔24h打印昨天生产和消费的消息数量</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">period</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line"><span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            BrokerController.<span class="built_in">this</span>.getBrokerStats().record();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.error(<span class="string">&quot;schedule record error.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//每隔5s將消费者offset进行持久化，存入consumerOffset.json文件中</span></span><br><span class="line"><span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            BrokerController.<span class="built_in">this</span>.consumerOffsetManager.persist();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.error(<span class="string">&quot;schedule persist consumerOffset error.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="built_in">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//每隔10s將消费过滤信息进行持久化，存入consumerFilter.json文件中</span></span><br><span class="line"><span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            BrokerController.<span class="built_in">this</span>.consumerFilterManager.persist();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.error(<span class="string">&quot;schedule persist consumer filter error.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//每隔3m將检查消费者的消费进度</span></span><br><span class="line"><span class="comment">//当消费进度落后阈值的时候，并且disableConsumeIfConsumerReadSlowly=true(默认false)，就停止消费者消费，保护broker，避免消费积压</span></span><br><span class="line"><span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            BrokerController.<span class="built_in">this</span>.protectBroker();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.error(<span class="string">&quot;protectBroker error.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line"><span class="comment">//每隔1s將打印发送消息线程池队列、拉取消息线程池队列、查询消息线程池队列、结束事务线程池队列的大小以及队列头部元素存在时间</span></span><br><span class="line"><span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            BrokerController.<span class="built_in">this</span>.printWaterMark();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.error(<span class="string">&quot;printWaterMark error.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">//每隔1m將打印已存储在commitlog提交日志中但尚未分派到consume queue消费队列的字节数。</span></span><br><span class="line"><span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.info(<span class="string">&quot;dispatch behind commit log &#123;&#125; bytes&quot;</span>, BrokerController.<span class="built_in">this</span>.getMessageStore().dispatchBehindBytes());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            log.error(<span class="string">&quot;schedule dispatchBehindBytes error.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果broker的nameServer地址不为null</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.brokerConfig.getNamesrvAddr() != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//更新nameServer地址</span></span><br><span class="line">    <span class="built_in">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="built_in">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">    log.info(<span class="string">&quot;Set user specified name server address: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//如果没有指定nameServer地址，并且允许从地址服务器获取nameServer地址</span></span><br><span class="line">    <span class="comment">//那么每隔2m从nameServer地址服务器拉取最新的nameServer地址并更新</span></span><br><span class="line">    <span class="comment">//要想动态更新nameServer地址，需要指定一个地址服务器的url，并且fetchNamesrvAddrByAddressServer设置为true</span></span><br><span class="line">    <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                BrokerController.<span class="built_in">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                log.error(<span class="string">&quot;ScheduledTask fetchNameServerAddr exception&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果没有开启DLeger服务，DLeger开启后表示支持高可用的主从自动切换</span></span><br><span class="line"><span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//如果当前broker是slave从节点</span></span><br><span class="line">    <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="built_in">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//根据是否配置了HA地址，来更新HA地址，并设置updateMasterHAServerAddrPeriodically</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="built_in">this</span>.messageStore.updateHaMasterAddress(<span class="built_in">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">            <span class="built_in">this</span>.updateMasterHAServerAddrPeriodically = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="built_in">this</span>.updateMasterHAServerAddrPeriodically = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//如果是主节点，每隔60s將打印主从节点的差异</span></span><br><span class="line">        <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    BrokerController.<span class="built_in">this</span>.printMasterAndSlaveDiff();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                    log.error(<span class="string">&quot;schedule printMasterAndSlaveDiff error.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-8-初始化事务消息相关服务"><a href="#2-3-8-初始化事务消息相关服务" class="headerlink" title="2.3.8 初始化事务消息相关服务"></a>2.3.8 初始化事务消息相关服务</h4><p><strong>initialTransaction方法用于初始化事务消息相关服务。事务消息的服务采用Java SPI的方式进行加载。</strong></p>
<p><strong>主要初始化三个服务：</strong></p>
<p><strong>1、</strong> <strong>transactionalMessageService</strong>：事务消息服务用于处理、检查事务消息；<br><strong>2、</strong> <strong>transactionalMessageCheckListener</strong>：事务消息监检查监听器监听回查消息；<br><strong>3、</strong> <strong>transactionalMessageCheckService</strong><br>：事务消息检查服务提供了事务消息回查的逻辑默认情况下，6秒以上没commit&#x2F;rollback的事务消息才会触发事务回查，而如果回查次数超过15次则丢弃事务；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrokerController的方法</span></span><br><span class="line"><span class="comment"> * 初始化事务消息相关服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialTransaction</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//基于Java的SPI机制，查找&quot;META-INF/service/org.apache.rocketmq.broker.transaction.TransactionalMessageService&quot;文件里面的SPI实现</span></span><br><span class="line">    <span class="comment">//事务消息服务</span></span><br><span class="line">    <span class="built_in">this</span>.transactionalMessageService = ServiceProvider.loadClass(ServiceProvider.TRANSACTION_SERVICE_ID, TransactionalMessageService.class);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == <span class="built_in">this</span>.transactionalMessageService) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//如果沒有通过SPI指定具体的实现，那么使用默认实现，TransactionalMessageServiceImpl</span></span><br><span class="line">        <span class="built_in">this</span>.transactionalMessageService = <span class="keyword">new</span> <span class="title class_">TransactionalMessageServiceImpl</span>(<span class="keyword">new</span> <span class="title class_">TransactionalMessageBridge</span>(<span class="built_in">this</span>, <span class="built_in">this</span>.getMessageStore()));</span><br><span class="line">        log.warn(<span class="string">&quot;Load default transaction message hook service: &#123;&#125;&quot;</span>, TransactionalMessageServiceImpl.class.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//基于Java的SPI机制，查找&quot;META-INF/service/org.apache.rocketmq.broker.transaction.AbstractTransactionalMessageCheckListener&quot;文件里面的SPI实现</span></span><br><span class="line">    <span class="comment">//事务消息回查服务监听器</span></span><br><span class="line">    <span class="built_in">this</span>.transactionalMessageCheckListener = ServiceProvider.loadClass(ServiceProvider.TRANSACTION_LISTENER_ID, AbstractTransactionalMessageCheckListener.class);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == <span class="built_in">this</span>.transactionalMessageCheckListener) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//如果沒有通过SPI指定具体的实现，那么使用默认实现，DefaultTransactionalMessageCheckListener</span></span><br><span class="line">        <span class="built_in">this</span>.transactionalMessageCheckListener = <span class="keyword">new</span> <span class="title class_">DefaultTransactionalMessageCheckListener</span>();</span><br><span class="line">        log.warn(<span class="string">&quot;Load default discard message hook service: &#123;&#125;&quot;</span>, DefaultTransactionalMessageCheckListener.class.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.transactionalMessageCheckListener.setBrokerController(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//创建TransactionalMessageCheckService服务，该服务内部有一个线程</span></span><br><span class="line">    <span class="comment">//会定时每一分钟(可通过在broker.conf文件设置transactionCheckInterval属性更改)触发事务检查的逻辑，内部调用TransactionalMessageService#check方法</span></span><br><span class="line">    <span class="comment">//默认情况下，6秒以上没commit/rollback的事务消息才会触发事务回查，而如果回查次数超过15次则丢弃事务</span></span><br><span class="line">    <span class="built_in">this</span>.transactionalMessageCheckService = <span class="keyword">new</span> <span class="title class_">TransactionalMessageCheckService</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-9-初始化ACL权限服务"><a href="#2-3-9-初始化ACL权限服务" class="headerlink" title="2.3.9 初始化ACL权限服务"></a>2.3.9 初始化ACL权限服务</h4><p><strong>加载权限相关校验器。同样是基于Java的SPI机制进行查找，并且会将找到校验器注册到RpcHock中，在请求执行之前会执行权限校验。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrokerController的方法</span></span><br><span class="line"><span class="comment"> * 初始化ACL权限校验器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialAcl</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//校验是否开启了ACL，默认false，所以直接返回了</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.brokerConfig.isAclEnable()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        log.info(<span class="string">&quot;The broker dose not enable acl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果开启了ACL，则首先通过SPI机制获取AccessValidator</span></span><br><span class="line">    List&lt;AccessValidator&gt; accessValidators = ServiceProvider.load(ServiceProvider.ACL_VALIDATOR_ID, AccessValidator.class);</span><br><span class="line">    <span class="keyword">if</span> (accessValidators == <span class="literal">null</span> || accessValidators.isEmpty()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        log.info(<span class="string">&quot;The broker dose not load the AccessValidator&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将校验器存入accessValidatorMap，并且注册到RpcHook中，在请求之前会执行校验。</span></span><br><span class="line">    <span class="keyword">for</span> (AccessValidator accessValidator : accessValidators) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">final</span> <span class="type">AccessValidator</span> <span class="variable">validator</span> <span class="operator">=</span> accessValidator;</span><br><span class="line">        accessValidatorMap.put(validator.getClass(), validator);</span><br><span class="line">        <span class="built_in">this</span>.registerServerRPCHook(<span class="keyword">new</span> <span class="title class_">RPCHook</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBeforeRequest</span><span class="params">(String remoteAddr, RemotingCommand request)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//Do not catch the exception</span></span><br><span class="line">                <span class="comment">//在执行请求之前会进行校验</span></span><br><span class="line">                validator.validate(validator.parse(request, remoteAddr));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterResponse</span><span class="params">(String remoteAddr, RemotingCommand request, RemotingCommand response)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-10-初始化RpCHook"><a href="#2-3-10-初始化RpCHook" class="headerlink" title="2.3.10 初始化RpCHook"></a>2.3.10 初始化RpCHook</h4><p><strong>基于Java的SPI机制查找RpCHook，并且注册到netty远程服务中。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrokerController的方法</span></span><br><span class="line"><span class="comment"> * 初始化RpcHook服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialRpcHooks</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//通过SPI机制获取RPCHook的实现</span></span><br><span class="line">    List&lt;RPCHook&gt; rpcHooks = ServiceProvider.load(ServiceProvider.RPC_HOOK_ID, RPCHook.class);</span><br><span class="line">    <span class="comment">//如果没有配置RpcHook，那么直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (rpcHooks == <span class="literal">null</span> || rpcHooks.isEmpty()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//遍历并且注册所有的RpcHook</span></span><br><span class="line">    <span class="keyword">for</span> (RPCHook rpcHook : rpcHooks) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.registerServerRPCHook(rpcHook);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>RpcHook是RocketMQ提供的钩子类，提供一种类似于类似于AOP的功能。可以在请求被处理之前和响应被返回之前执行对应的方法。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RPCHook</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * broker处理请求之前执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doBeforeRequest</span><span class="params">(<span class="keyword">final</span> String remoteAddr, <span class="keyword">final</span> RemotingCommand request)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * broker响应返回之前执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doAfterResponse</span><span class="params">(<span class="keyword">final</span> String remoteAddr, <span class="keyword">final</span> RemotingCommand request,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> RemotingCommand response)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-多端口监听"><a href="#2-4-多端口监听" class="headerlink" title="2.4 多端口监听"></a>2.4 多端口监听</h3><p><strong>从源码可以得知，Broker启动时，实际上默认会监听3个端口：10909、10911、10912</strong></p>
<p><strong>1、</strong> <strong>remotingServer</strong>：监听10911端口，可以用于处理客户端的所有请求；<br><strong>2、</strong> fastRemotingServer：监听listenPort-2端口，默认10909，对应可以处理客户端除了拉取消息之外的所有请求，所谓的VIP端口；<br><strong>3、</strong> <strong>haListenPort</strong>：监听listenPort+1端口，默认10912，用于Broker的主从同步，即高可用服务；</p>
<p>**客户端生产者发送消息是默认请求fastRemotingServer，即所谓的VIP通道，但可以通过关闭VIP通道配置为使用remotingServer。消费者拉取消息只能请求remotingServer。<br>**</p>
<p><a href="https://github.com/apache/rocketmq/issues/1510">为什么要开启两个端口监听客户端请求呢</a><br>？答案是隔离读写操作。在消息的API中，最重要的是发送消息，需要高RTT。如果普通端口的请求繁忙，会使得netty的IO线程阻塞，例如消息堆积的时候，消费消息的请求会填满IO线程池，导致写操作被阻塞。在这种情况下，我们可以向VIP频道发送消息，以保证发送消息的RTT。</p>
<p>但是，请注意，在<strong>rocketmq 4.5.1</strong><br>版本之后，客户端发送消息的请求选择VIP通道的配置被改为false，想要手动默认开启需要配置com.rocketmq.sendMessageWithVIPChannel属性。或者在创建producer的时候调用producer.setVipChannelEnabled()<br>方法更改当前producer的配置。</p>
<p><img src="https://gitee.com/fadeway32/fadeway32/raw/master/img/202502162024860.png" alt="*"></p>
<p><strong>因此，现在发送消息和消费消息实际上默认都走10911端口了，无需再关心10909端口的问题了。</strong></p>
<h2 id="3-Start启动BrokerController"><a href="#3-Start启动BrokerController" class="headerlink" title="3 Start启动BrokerController"></a>3 Start启动BrokerController</h2><p>在创建并且初始化Broker之后，开始启动Broker。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrokerStartup的方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> controller 被启动的BrokerController</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title function_">start</span><span class="params">(BrokerController controller)</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//启动broker</span></span><br><span class="line">        controller.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//broker启动之后的的信息打印到控制台</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tip</span> <span class="operator">=</span> <span class="string">&quot;The broker[&quot;</span> + controller.getBrokerConfig().getBrokerName() + <span class="string">&quot;, &quot;</span></span><br><span class="line">                + controller.getBrokerAddr() + <span class="string">&quot;] boot success. serializeType=&quot;</span> + RemotingCommand.getSerializeTypeConfigInThisServer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != controller.getBrokerConfig().getNamesrvAddr()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            tip += <span class="string">&quot; and name server is &quot;</span> + controller.getBrokerConfig().getNamesrvAddr();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(tip);</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s%n&quot;</span>, tip);</span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>*我们来看看BrokerController#start方法。主要是启动各种服务和组件，例如messageStore、remotingServer、fastRemotingServer等等。其中remotingServer、fastRemotingServer的start方法实际上就是NettyRemotingServer的start方法，我们在上一篇namserver的源码中就已经介绍过了。<br>**</li>
</ul>
<p>然后还会判断，如果没有开启<a href="https://github.com/apache/rocketmq/blob/master/docs/cn/dledger/deploy_guide.md">Dledger</a><br>（默认不会开启），那么如果当broker不是SLAVE，那么启动transactionalMessageCheckService事务消息检查服务，如果是SLAVE，那么启动定时任务每隔10s与master机器同步数据，采用slave主动拉取的方法。诸侯会调用registerBrokerAll强制注册当前broker信息到所有的nameserver。</p>
<p>该方法的最后还会开启另一个定时周期任务，默认情况下每隔30s向所有的nameServer进行一次注册broker信息，时间间隔可以配置registerNameServerPeriod属性，允许的值是在1万到6万毫秒之间。这个定时任务就是Broker向nameserver发送的心跳包的定时任务，包括topic名、读、写队列个数、队列权限、是否有序等信息。</p>
<p>既然Broker会定时的发送心跳包任务，那么nameServer肯定也有定时的心跳检测任务，具体的Broker和nameServer之间的心跳功能源码后面会专门讲解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrokerController的方法</span></span><br><span class="line"><span class="comment"> * 启动BrokerController</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//启动消息存储服务</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.messageStore != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.messageStore.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动netty远程服务</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.remotingServer != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.remotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动快速netty远程服务</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.fastRemotingServer != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.fastRemotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件监听器启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.fileWatchService != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.fileWatchService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//broker对外api启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.brokerOuterAPI != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.brokerOuterAPI.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//长轮询拉取消息挂起服务启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.pullRequestHoldService != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.pullRequestHoldService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//客户端连接心跳服务启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.clientHousekeepingService != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.clientHousekeepingService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过滤服务管理器启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.filterServerManager != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.filterServerManager.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果没有开启DLeger的相关设置，默认没有启动</span></span><br><span class="line">    <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="comment">//如果不是SLAVE，那么启动transactionalMessageCheckService事务消息检查服务</span></span><br><span class="line">        startProcessorByHa(messageStoreConfig.getBrokerRole());</span><br><span class="line">        <span class="comment">//如果是SLAVE，那么启动定时任务每隔10s与master机器同步数据，采用slave主动拉取的方法</span></span><br><span class="line">        <span class="comment">//同步的内容包括topic配置，消费者消费位移、延迟消息偏移量、订阅组信息等</span></span><br><span class="line">        handleSlaveSynchronize(messageStoreConfig.getBrokerRole());</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 强制注册当前broker信息到所有的nameserver</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.registerBrokerAll(<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动定时任务，默认情况下每隔30s向nameServer进行一次注册，</span></span><br><span class="line">    <span class="comment">//时间间隔可以配置registerNameServerPeriod属性，允许的值是在1万到6万毫秒之间。</span></span><br><span class="line">    <span class="built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                <span class="comment">//定时发送心跳包并上报数据</span></span><br><span class="line">                BrokerController.<span class="built_in">this</span>.registerBrokerAll(<span class="literal">true</span>, <span class="literal">false</span>, brokerConfig.isForceRegister());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">                log.error(<span class="string">&quot;registerBrokerAll Exception&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">10</span>, Math.max(<span class="number">10000</span>, Math.min(brokerConfig.getRegisterNameServerPeriod(), <span class="number">60000</span>)), TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">//broker相关统计服务启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.brokerStatsManager != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.brokerStatsManager.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//broker快速失败服务启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.brokerFastFailure != <span class="literal">null</span>) &#123;</span><br><span class="line">   </span><br><span class="line">     </span><br><span class="line">        <span class="built_in">this</span>.brokerFastFailure.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Broker启动流程总结"><a href="#4-Broker启动流程总结" class="headerlink" title="4 Broker启动流程总结"></a>4 Broker启动流程总结</h2><p>**通过对Broker模块启动源码的整体通读，我们可以发现Broker启动的源码和原理相比于此前的nameserver模块来说，困难了很多，但是也有相似的地方。<br>**</p>
<p>**Broker的启动同样可以分为两个大步骤，一个是实例化和初始化BrokerController，另一个启动BrokerController，这一点和nameserver模块的启动来说是一样的。<br>**</p>
<ul>
<li>*不同的是，Broker模块启动时还会加载很多的文件，这个文件包括topic的各种信息topics.json，消费者的各种信息consumerOffset.json等等文件，重要的是还会加载各种消息文件，例如commitlog、consumequeue、indexfile文件等等，在加载了消息文件之后，会对文件进行恢复。<br>**</li>
</ul>

                
                <p class="end">__END__</p>
            </div>
            <div class="article-footer">
                <div class="suffix-box">
    <div class="suffix-box-left">
        <img src="/image/sidebar/avatar.jpg" alt="Live For Code">
    </div>
    <div class="suffix-box-right">
        <span class="suffix-box-title">文章作者：</span>Live For Code
        <br>
        <span class="suffix-box-title">文章出处：</span><a href="/article/1739713328/" target="_blank">03、RocketMQ源码分析：Broker启动流程源码解析【一万字】</a>
        <br>
        <span class="suffix-box-title">作者签名：</span>你知道的越多,你不知道的越多
        <br>
        <span class="suffix-box-title">关于主题：</span><a href="https://fadeway32.gitee.io/" target="_blank">fadeway32</a>
        <br>
        <span class="suffix-box-title">版权声明：</span>文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" title="BY-NC-SA" target="_blank">BY-NC-SA</a> 许可协议，转载请注明出处
        <br>
    </div>
    <div style="clear: both;"></div>
</div>
                
                    <div class="category">
                        分类：
                        
                            <a href="/category/Web/">Web</a>
                        
                    </div>
                
                
                    <div class="tag">
                        标签：
                        
                            <a href="/tag/RocketMq/">RocketMq</a>
                        
                    </div>
                
                <div class="article-prev-next">
                    
                        <a href="/article/1739713329/" class="prev-prefix">« </a> 上一篇：    <a href="/article/1739713329/" title="发布于 2025-02-16 09:42">04、RocketMQ源码分析：Broker启动加载消息文件以及恢复数据源码【一万字】</a>
                        <br>
                    
                    
                        <a href="/article/1739713331/" class="next-prefix">» </a> 下一篇：    <a href="/article/1739713331/" title="发布于 2025-02-16 09:42">06、RocketMQ源码分析：Producer生产者启动源码【一万字】</a>
                    
                </div>
            </div>
            
    <div class="article-comments">
        
            <div class="comments-title">
                评论列表
            </div>
        
        <div class="comments-content"></div>
    </div>

        </div>
    
</div>
    <div id="footer"></div>
    <div id="sidebar">
    <div class="menu-wrap" style="display:none;">
        
            <div class="menu-notice">
                <span class="iconfont icon-notice"></span>
                <div class="notice">
                    <span>简单地活着，肆意而又精彩！</span>
                </div>
            </div>
        
        <nav class="menu">
            <div class="menu-introduce"> 
                <div class="introduce-avatar">
                    <img src="/image/sidebar/avatar.jpg">
                </div> 
                <div class="introduce-info"> 
                    <div class="introduce-user"><span>Live For Code</span></div>
                </div> 
            </div> 
            <div class="menu-list">
                <ul>
                    
                        <li class=""><a href="/" class="" target="_self"><span class="iconfont icon-home-fill"></span>首页</a></li>
                    
                        <li class=""><a href="/category" class="" target="_self"><span class="iconfont icon-folder-fill"></span>分类</a></li>
                    
                        <li class=""><a href="/tag" class="" target="_self"><span class="iconfont icon-discount-fill"></span>标签</a></li>
                    
                        <li class=""><a href="/archive" class="" target="_self"><span class="iconfont icon-calendar-fill"></span>归档</a></li>
                    
                        <li class=""><a href="/donate" class="" target="_self"><span class="iconfont icon-heart-fill"></span>赞赏</a></li>
                    
                        <li class=""><a href="/about" class="" target="_self"><span class="iconfont icon-about-fill"></span>关于</a></li>
                    
                        <li class=""><a href="/atom.xml" class="" target="_blank"><span class="iconfont icon-rss"></span>订阅</a></li>
                    
                        <li class=""><a href="javascript:;" class="search" target="_self"><span class="iconfont icon-search-menu"></span>搜索</a></li>
                    
                        <li class=""><a href="/comment" class="" target="_self"><span class="iconfont icon-comments-fill"></span>留言板</a></li>
                    
                        <li class=""><a href="/friend" class="" target="_self"><span class="iconfont icon-link"></span>友情链接</a></li>
                    
                </ul> 
            </div> 
            <div class="menu-link">
                <div class="box">
                    <div class="image-box"></div>
                </div>
                
                    <a name="知乎" href="https://www.zhihu.com/people/wo-xin-de-love" class="" target="_blank" data=""><span class="iconfont icon-zhihu"></span></a>
                
                    <a name="微博" href="https://weibo.com/u/3939432776" class="" target="_blank" data=""><span class="iconfont icon-weibo"></span></a>
                
                    <a name="QQ" href="javascript:;" class="image" target="_self" data="https://gitee.com/fadeway32/fadeway32/raw/master/img/B5C4BECA9D2E1BBE5B5B9020421E9426.png"><span class="iconfont icon-qq"></span></a>
                
                    <a name="微信" href="javascript:;" class="image" target="_self" data="https://gitee.com/fadeway32/fadeway32/raw/master/img/F35AB4B62DEAE3B5DC2907087E35424E.png"><span class="iconfont icon-wechat"></span></a>
                
                    <a name="GitHub" href="https://github.com/first19326" class="" target="_blank" data=""><span class="iconfont icon-github"></span></a>
                
            </div> 
        </nav>
        <button class="menu-button-close"></button>
        <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
            </svg>
        </div>
    </div>
    <button class="menu-button-open">MENU</button>
    <div class="menu-cover"></div>
</div>
    <link type="text/css" rel="stylesheet" href="/css/search.css">
<script type="text/javascript" src="/js/iscroll.js"></script>
<script type="text/javascript" src="/js/instantsearch.min.js"></script>
<div class="search-window">
    <div class="search-content">
        <div class="search-content-icon">
            <i class="iconfont icon-search"></i>
        </div>
        <div id="search-input" class="search-input"></div>
    </div>

    <div class="search-scroll">
        <div class="search-result">
            <div id="search-stats" class="search-stats"></div>
            <div id="search-hits"></div>
            <div id="search-pagination" class="search-pagination"></div>
        </div>
    </div>

    <span class="search-close-icon">
        <i class="iconfont icon-close"></i>
    </span>
</div>
    <div id="tools">
    <div class="progressbar-top"></div>

    
        <link type="text/css" rel="stylesheet" href="/css/APlayer.css">
        <script type="text/javascript" src="/js/APlayer.min.js"></script>
        <script type="text/javascript" src="/js/Meting.min.js"></script>
        <meting-js id="3778678" lrcshow="false" server="netease" type="playlist" fixed="true" autoplay="false" loop="all" order="random" preload="auto" volume="0.67" mutex="true"></meting-js>
    
    
    <div class="wrap-right">
        <div class="setting">
            <div class="iconbox favorites" switch="false">
                <span class="iconfont icon-favorites"></span>
                <span class="icontext">关注</span>
            </div>
            <div class="iconbox mode">
                <div class="light">
                    <span class="iconfont icon-daymode"></span>
                    <span class="icontext">浅色模式</span>
                </div>
                <div class="dark">
                    <span class="iconfont icon-nightmode-fill"></span>
                    <span class="icontext">深色模式</span>
                </div>
            </div>
            <a href="javascript:;" target="_self" class="search">
                <div class="iconbox">
                    <span class="iconfont icon-search-menu"></span>
                    <span class="icontext">搜索</span>
                </div>
            </a>
            <div class="iconbox bottom">
                <div style="display: inline-block; transform: rotate(180deg);">
                    <span class="iconfont icon-top"></span>
                </div>
                <span class="icontext">跳至底部</span>
            </div>
        </div>
        <div class="iconbox set">
            <div style="display: inline-block;">
                <span class="iconfont icon-setting"></span>
            </div>
            <span class="icontext">设置</span>
        </div>
        <div class="iconbox top">
            <span class="iconfont icon-top"></span>
            <span class="icontext">返回顶部</span>
        </div>
    </div>
    <div class="loading"></div>
</div>
    <script>
    window.config = {
        GitHubUserName     : "first19326",
        GitHubRepositories : "Hexo-LiveForCode",

        User             : "Live For Code",
        UserAvatar       : "/image/sidebar/avatar.jpg",
        WebsiteStartDate : "2020-01-01",

        WebsiteTitleBlur         : "(◍´꒳`◍) Hi, Live For Code",
        WebsiteTitleBlurTimeOut  : 500,
        WebsiteTitleFocus        : "(*´∇｀*) 欢迎回来!",
        WebsiteTitleFocusTimeOut : 1000,
        WebsiteFavicon           : "/image/website/logo.png",

        ProgressBar : {
            id       : "topProgressBar",
            color    : "#77B6FF",
            height   : "2px",
            duration : 0.2
        },

        Loading: {
            rebound : {
                tension  : 16,
                friction : 5
            },
            spinner : {
                id     : "spinner",
                radius : 90,
                sides  : 3,
                depth  : 4,
                colors : {
                    background : "#F0F0F0",
                    stroke     : "#272633",
                    base       : "",
                    child      : "#272633"
                },
                alwaysForward : true,
                restAt        : 0.5,
                renderBase    : false
            }
        },

        HomeHeaderAnimationRendered : true,
        HomeHeaderAnimation         : {
            radius      : 15,
            density     : 0.2,
            color       : "rgba(255, 255, 255, .2)",
            clearOffset : 0.3
        },

        BackAnimationRendered          : true,
        IEBrowserBackAnimationRendered : false,
        BackAnimation                  : {
            colorSaturation  : "60%",
            colorBrightness  : "50%",
            colorAlpha       : 0.5,
            colorCycleSpeed  : 5,
            verticalPosition : "random",
            horizontalSpeed  : 200,
            ribbonCount      : 3,
            strokeSize       : 0,
            parallaxAmount   : -0.2,
            animateSections  : true
        },

        HomeHeaderImage : [
            
                "/image/header/home.jpg",
            
                "/image/header/home.jpeg",
            
                "/image/header/2023-04-17-20-51-03.jpg",
            
                "/image/header/2023-04-17-20-54-07.jpg",
            
                "/image/header/2023-04-17-20-54-22.jpg",
            
                "/image/header/2023-04-17-20-55-25.jpg",
            
                "/image/header/2023-04-17-21-04-19.jpg",
            
                "/image/header/2023-04-17-21-04-34.jpg",
            
                "/image/header/2023-04-17-21-04-41.jpg",
            
                "/image/header/2023-04-17-21-05-22.jpg",
            
        ],
        HomeBannerText  : "",

        ArticleHeaderImage : [
            
                "/image/header/article.jpg",
            
                "/image/header/2023-04-17-21-04-19.jpg",
            
                "/image/header/2023-04-17-21-04-34.jpg",
            
                "/image/header/2023-04-17-21-04-41.jpg",
            
                "/image/header/2023-04-17-21-05-22.jpg",
            
        ],

        OtherBannerText : "",

        Error : {
            icon    : "icon-swimming",
            title   : "PAGE NOT FOUND",
            content : [
                
                    "很抱歉，您访问的页面不存在！",
                
                    "可能是输入地址有误或该地址已变更。",
                
            ],
            buttons : [
                
                    {
                        icon  : "icon-home",
                        text  : "返回首页",
                        href  : "https://fadeway32.gitee.io/",
                        class : ""
                    },
                
            ]
        },

        MenuNotice : {
            enable : true,
            notice : "简单地活着，肆意而又精彩！",
            speed  : 20
        },
        MenuList : [
            
                {
                    name   : "首页",
                    icon   : "icon-home-fill",
                    href   : "/",
                    type   : "index",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "分类",
                    icon   : "icon-folder-fill",
                    href   : "/category",
                    type   : "category",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "标签",
                    icon   : "icon-discount-fill",
                    href   : "/tag",
                    type   : "tag",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "归档",
                    icon   : "icon-calendar-fill",
                    href   : "/archive",
                    type   : "archive",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "赞赏",
                    icon   : "icon-heart-fill",
                    href   : "/donate",
                    type   : "donate",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "关于",
                    icon   : "icon-about-fill",
                    href   : "/about",
                    type   : "about",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "订阅",
                    icon   : "icon-rss",
                    href   : "/atom.xml",
                    type   : "",
                    class  : "",
                    target : "_blank"
                },
            
                {
                    name   : "搜索",
                    icon   : "icon-search-menu",
                    href   : "javascript:;",
                    type   : "",
                    class  : "search",
                    target : "_self"
                },
            
                {
                    name   : "留言板",
                    icon   : "icon-comments-fill",
                    href   : "/comment",
                    type   : "comment",
                    class  : "",
                    target : "_self"
                },
            
                {
                    name   : "友情链接",
                    icon   : "icon-link",
                    href   : "/friend",
                    type   : "friend",
                    class  : "",
                    target : "_self"
                },
            
        ],
        MenuLink : [
            
                
                    {
                        name   : "知乎",
                        icon   : "icon-zhihu",
                        href   : "https://www.zhihu.com/people/wo-xin-de-love",
                        class  : "",
                        target : "_blank",
                        image  : ""
                    },
                
                    {
                        name   : "微博",
                        icon   : "icon-weibo",
                        href   : "https://weibo.com/u/3939432776",
                        class  : "",
                        target : "_blank",
                        image  : ""
                    },
                
                    {
                        name   : "QQ",
                        icon   : "icon-qq",
                        href   : "javascript:;",
                        class  : "image",
                        target : "_self",
                        image  : "https://gitee.com/fadeway32/fadeway32/raw/master/img/B5C4BECA9D2E1BBE5B5B9020421E9426.png"
                    },
                
                    {
                        name   : "微信",
                        icon   : "icon-wechat",
                        href   : "javascript:;",
                        class  : "image",
                        target : "_self",
                        image  : "https://gitee.com/fadeway32/fadeway32/raw/master/img/F35AB4B62DEAE3B5DC2907087E35424E.png"
                    },
                
                    {
                        name   : "GitHub",
                        icon   : "icon-github",
                        href   : "https://github.com/first19326",
                        class  : "",
                        target : "_blank",
                        image  : ""
                    },
                
            
        ],

        FooterStyle : 2,
        BottomText  : "<div><span class='face'>ღゝ◡╹)ノ♡</span></div><div>【人生若只如初见<span><i class='iconfont icon-like-fill'></i></span>何事秋风悲画扇】</div><div>&copy; 2020-2022 WorstOne. All Rights Reserved.</div>",

        ConsoleList : [
            
                
                    [
                        
                            
                                "Based on cnblogs theme SimpleMemory.",
                            
                                "",
                            
                        
                    ],
                
                    [
                        
                            
                                "SimpleMemory Author:",
                            
                                "BNDong",
                            
                        
                    ],
                
                    [
                        
                            
                                "Theme:",
                            
                                "LiveForCode",
                            
                        
                    ],
                
            
        ],

        FontIconExtend : "",

        Donate : {
            paypal  : "",
            bitcoin : "",
            alipay  : "/image/donate/alipay.png",
            wechat  : "/image/donate/wechat.png"
        },

        Search : {
            applicationID : "758UIQ1V0H",
            apiKey        : "2e038c318ac6813e4b4baa91f6ccfa63",
            indexName     : "hexo2",
            hits          : {
                page : 30
            },
            labels        : {
                placeholder : "搜索",
                empty       : "未发现与 「${query}」 相关的内容",
                stats       : "${hits} 条相关条目，使用了 ${time} 毫秒",
            }
        }, 

        Valine : {
            switch         : true,
            el             : ".comments-content",
            appId          : "srhKtvWPQTWYKh3qX8G8M7v0-gzGzoHsz",
            appKey         : "8uVSP1q6UlALVC5igYfIfv2h",
            serverURLs     : "",
            placeholder    : "你是我一生只会遇见一次的惊喜...",
            avatar         : "mm",
            meta           : "nick,mail,link",
            requiredFields : "nick,mail",
            pageSize       : 5,
            lang           : "zh-cn",
            visitor        : true,
            enableQQ       : true
        },

        Tocbot : {
            switch                : true,
            tocSelector           : ".toc",
            contentSelector       : ".article-body",
            headingSelector       : "h1, h2, h3, h4, h5",
            headingsOffset        : 0,
            scrollSmooth          : true,
            scrollSmoothOffset    : -5,
            positionFixedSelector : ".toc",
            positionFixedClass    : "toc-fixed",
            fixedSidebarOffset    : "",
        },

        Require : {
            baseUrl     : "/js/",
            waitSeconds : 100
        },

        Music : {
            type : "Meting"
        },
        APlayer : {
            container : ".aplayer",
            fixed     : true,
            autoplay  : true,
            loop      : "all",
            order     : "random",
            preload   : "auto",
            volume    : 0.67,
            mutex     : true,
            lrcType   : 2,
            audio     : [
                
                    {
                        name   : "Endless Tears",
                        artist : "CLIFF EDGE",
                        cover  : "/music/cover/Endless Tears.jpg",
                        url    : "/music/song/Endless Tears.mp3",
                        lrc    : "/music/lrc/Endless Tears.lrc"
                    },
                
            ]
        },
        Meting : {
            id       : "3778678", 
            lrcshow  : false, 
            server   : "netease", 
            type     : "playlist", 
            fixed    : true, 
            autoplay : false, 
            loop     : "all", 
            order    : "random", 
            preload  : "auto", 
            volume   : 0.67, 
            mutex    : true
        },

        Mouse : {
            enable  : true,
            options : {
                size  : 6,
                sizeF : 24
            }
        },

        LazyLoad : {
            default : "/image/website/lazyload.svg"
        },
  
        Style : {
            aplayer          : "/css/APlayer.css",
            archive          : "/css/archive.css",
            base             : "/css/base.css",
            clipboard        : "/css/clipboard.css",
            code             : "/css/code.css",
            donate           : "/css/donate.css",
            fancybox         : "/css/jquery.fancybox.css",
            footer           : "/css/footer.css",
            iconfont         : "/iconfont/iconfont.css",
            index            : "/css/index.css",
            menuBubble       : "/css/menu-bubble.css",
            mouse            : "/css/mouse.css",
            page             : "/css/page.css",
            post             : "/css/post.css",
            search           : "/css/search.css",
            tocbot           : "/css/tocbot.css",
            valine           : "/css/valine.css"
        },

        Script: {
            aplayer          : "/js/APlayer.min.js",
            config           : "/js/require.config.js",
            index            : "/js/index.js",
            instantSearch    : "/js/instantsearch.min.js",
            iscroll          : "/js/iscroll.js",
            jQuery           : "/js/jquery-3.4.1.min.js",
            loading          : "/js/loading.js",
            meting           : "/js/Meting.min.js",
            require          : "/js/require.min.js"
        },

        Font: {
            LongCang    : "/font/LongCang.css",
            Monda       : "/font/Monda.css",
            NotoSansSC  : "/font/NotoSansSC.css",
            NotoSerifSC : "/font/NotoSerifSC.css",
            Playball    : "/font/Playball.css",
            PTMono      : "/font/PTMono.css",
            Roboto      : "/font/Roboto.css",
            RobotoSlab  : "/font/RobotoSlab.css",
            Rosario     : "/font/Rosario.css",
            UbuntuMono  : "/font/UbuntuMono.css"
        },

        Suffix : {
            about : "你知道的越多,你不知道的越多"
        },
            
        Theme : {
            url  : "https://fadeway32.gitee.io/",
            name : "fadeway32"
        }  
    };
</script>
    <script type="text/javascript" src="/js/index.js"></script>
</body>
</html>